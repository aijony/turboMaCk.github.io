<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Hybrid Types in TypeScript</title>
    <link rel="icon" type="image/png" href="../favicon.png" />
    <link href="https://fonts.googleapis.com/css?family=Cabin:400,400i,700,700i|Open+Sans:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
  </head>
  <body>
    <header class="page-header">
        <nav class="navigation">
            
                <a href="../index.html">Home</a>
                <a href="../archive.html" class="active">B\og</a>
            
        </nav>
    </header>

    <main class="main-container">
      <div class="content">
        <h1>
          Hybrid Types in TypeScript
          
            <span class="subtitle">Being Dynamic With Type Checker</span>
          
        </h1>

        <div class="info">
    Posted on December  7, 2016
    
</div>

<p>Yesterday I’ve been refactoring one of our internal library in <a href="globalwebindex.net">GWI</a> from JavaScript to TypeScript. As a JavaScript veteran I like to use some edgy non-conventional &amp; pre-ES 2015 coding styles. I’m not using <code>prototype</code>, <code>class</code> or <code>this</code> much often. I’m rather using <a href="http://javascript.info/tutorial/factory-constructor-pattern">Factory Constructor Pattern</a> quite often as well as <a href="https://en.wikipedia.org/wiki/Higher-order_function">Higher Order Functions</a> for simulating <a href="https://en.wikipedia.org/wiki/Currying">currying</a> and like to with objects and play with scopes. Now you might think that this is silly. No one will understand my code and using truly private functions makes it harder to extend functionality. And you’re right:D Anyway I know that I can write more reliable code more quickly and from my experience when code is reliable enough not many people will need to change it. And when they do they are mostly experienced and are able to understand it. Also I like private functions. If you miss any functionality or abstraction it’s always good idea to add it directly to library or write your own than hack it. Anyway this article is not about these patterns and how to use them but rather about how it feels when you put <a href="https://www.typescriptlang.org">TypeScript</a> in the mix. If you want to learn more about these patterns <a href="https://duckduckgo.com/">DuckDuckGo</a> some other article.</p>
<p>First let me explain one thing. I’m not writing TypeScript day to day. But when I do I’m mostly exploring edges of what it can do. I’m writing a lot of ES 2015 ECMAScript in work and <a href="elm-lang.org">Elm</a> for fun (what is slowly changing since we already shipped first feature written in Elm elm as part of our production <a href="ember.js">Ember.js</a> app).</p>
<h2 id="problem">Problem</h2>
<p>The idea is this. We have got our internal system for charts written in <a href="https://d3js.org/">D3.js</a>. Some parts of this are <a href="https://github.com/GlobalWebIndex/d3scription">open-sourced and available on GitHub</a>. In GWI we have got whole charts written in pure D3 that are sharing common interface so on application layer you’re basically just dynamically switching factory functions for charts based on based on chart type and everything works like a magic. However testing visualization layer is hard or even impossible. Wouldn’t it be a good idea to have at least type check for these interfaces? I think it would!</p>
<p>For purpose of this tutorial I’ve picked one smaller part rather than whole chart. D3 itself comes with component called <a href="https://github.com/d3/d3/blob/master/API.md#axes-d3-axis">d3.svg.axis</a>. However sometimes it doesn’t fit your needs so you’ll need to implement your own solution. Lets say we want to implement custom axis which will create ticks based on data we have so for each data-point it will create a tick on axis. This is how we want to use our new component:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">const</span> axis <span class="op">=</span> <span class="at">exactAxis</span>()
    .<span class="at">scale</span>(scale)
    .<span class="at">data</span>(someData)
    .<span class="at">tickFormat</span>(d <span class="op">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>

<span class="va">d3</span>.<span class="at">select</span>(<span class="st">'.axis-group'</span>).<span class="at">call</span>(axis)<span class="op">;</span></code></pre></div>
<p>As you can see I’ve chosen <code>exactAxis</code> as a name for this component. It’s a <code>function</code>. However it returns some <code>Object</code> that has at least <code>scale</code>, <code>data</code> &amp; <code>tickFormat</code> methods. We’re using chaining so at least <code>scale</code> and <code>data</code> should return object they are defined on. Also on the last line we are using <a href="https://github.com/d3/d3-selection/blob/master/README.md#selection_call">d3.selection.call</a> which means that <code>axis</code> (thing returned by <code>tickFormat</code> call) needs to be <code>function</code>. This might mean that <code>tickFormat</code> returns some <code>function</code> instead of <code>object</code> but that is silly idea. Then you will need to always call <code>tickFormat</code> as last method. That said I think we can agree that:</p>
<ul>
<li><code>exactAxis()</code> returns <code>function</code> (and <strong>functions are Objects in JavaScript</strong>) with all methods defined.</li>
<li>Each method will return object it’s called on (so we can chain method calls).</li>
</ul>
<h2 id="interface">Interface</h2>
<p>Now we know what we need so lets define interface for out <code>exactTip</code> function.</p>
<pre class="typescript"><code>import * as d3 from 'd3';

interface TickFormat extends Function {
    (any) : string;
}

interface ExactAxis extends Function {
    (g : d3.Selection&lt;any&gt;) : void;
    scale(scale : d3.scale.Ordinal&lt;any, any&gt;) : ExactAxis;
    data(data : any[]) : ExactAxis;
    tickFormat(fc : TickFormat) : ExactAxis;
}</code></pre>
<p>As you can see there are some <code>any</code> used. Maybe it’s good idea to solve this using <a href="https://www.typescriptlang.org/docs/handbook/generics.html">Generics</a>.</p>
<pre class="typescript"><code>import * as d3 from 'd3';

interface TickFormat&lt;T&gt; extends Function {
    (data : T) : string;
}

interface ExactAxis&lt;T&gt; extends Function {
    (g : d3.Selection&lt;any&gt;) : void;
    scale(scale : d3.scale.Ordinal&lt;any, any&gt;) : ExactAxis&lt;T&gt;;
    data(data : T[]) : ExactAxis&lt;T&gt;;
    tickFormat(fc : TickFormat&lt;T&gt;) : ExactAxis&lt;T&gt;;
}</code></pre>
<p>OK this is better. Now it’s obvious that we are passing some data around.</p>
<p>There are still some <code>any</code> used for d3 parts but I think we can leave it.</p>
<h2 id="so-called-hybrid-types-in-ts">So Called Hybrid Types in TS</h2>
<p>Now we can actually start implementing our axis component. This was the part I was not familiar till yesterday. I was actually asking some friends who work with typescript daily how an interface like this can be implemented in typescript but unluckily no one knew. I knew how this can be done in JS but that implementation did not satisfy tsc (compiler). Than as all SW engineers I’ve turned my last hope to <a href="https://www.typescriptlang.org/docs/handbook/interfaces.html">documentation</a> and found part about <a href="https://www.typescriptlang.org/docs/handbook/interfaces.html#hybrid-types">Hybrid Types</a>.</p>
<blockquote>
<p>As we mentioned earlier, interfaces can describe the rich types present in real world JavaScript. Because of JavaScript’s dynamic and flexible nature, you may occasionally encounter an object that works as a combination of some of the types described above.</p>
</blockquote>
<p>That’s exactly what I was looking for!</p>
<p>Let’s have a look at how we minimal “implementation” that satisfy our interface:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> exactTip<span class="op">&lt;</span>T<span class="op">&gt;</span>() <span class="op">:</span> ExactTip<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> tip <span class="op">=</span> <span class="op">&lt;</span>ExactTip<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span><span class="kw">function</span>() <span class="op">{</span>
    <span class="op">}</span>

    <span class="va">tip</span>.<span class="at">scale</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">scale </span><span class="op">:</span> <span class="va">d3</span>.<span class="va">scale</span>.<span class="at">Ordinal</span><span class="op">&lt;</span>any<span class="op">,</span> any<span class="op">&gt;</span>) <span class="op">:</span> ExactTip<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        <span class="cf">return</span> tip<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">tip</span>.<span class="at">data</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">d </span><span class="op">:</span> T[]) <span class="op">{</span>
        <span class="cf">return</span> tip<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">tip</span>.<span class="at">tickFormat</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">fc </span><span class="op">:</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span>) <span class="op">:</span> ExactTip<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        <span class="cf">return</span> tip<span class="op">;</span>
    <span class="op">}</span>

    <span class="cf">return</span> tip<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>That’s it! Actually this won’t do anything but it’s whole boiler plate we need. Now comes the easy part. We can just simply implement logic (and that’s always simpler than designing API, right?)</p>
<p>So as a bonus - This is one possible implementation:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> exactTip<span class="op">&lt;</span>T<span class="op">&gt;</span>() <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
    <span class="co">// Constants</span>
    <span class="kw">const</span> <span class="dt">TEXT_DELTA </span><span class="op">:</span> number <span class="op">=</span> <span class="dv">25</span><span class="op">;</span>
    <span class="kw">const</span> <span class="dt">WITHOUT_TEXT_DELTA </span><span class="op">:</span> number <span class="op">=</span> <span class="fl">12.5</span><span class="op">;</span>

    <span class="co">// Instance variables</span>
    <span class="kw">let</span> <span class="dt">data </span><span class="op">:</span> T[] <span class="op">=</span> []<span class="op">;</span>
    <span class="kw">let</span> <span class="dt">tickFormat </span><span class="op">:</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> (d) <span class="op">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="sc">}</span><span class="vs">`</span><span class="op">;</span>
    <span class="kw">let</span> scale<span class="op">;</span>

    <span class="co">// Render</span>

    <span class="kw">const</span> tip <span class="op">=</span> <span class="op">&lt;</span>ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span><span class="kw">function</span>(g) <span class="op">{</span>

        <span class="co">// D3 always returns array</span>
        <span class="co">// Lets render axis for every given group.</span>
        <span class="va">g</span>.<span class="at">each</span>(<span class="kw">function</span>() <span class="op">{</span>
            <span class="kw">const</span> <span class="dt">$el </span><span class="op">:</span> <span class="va">d3</span>.<span class="at">Selection</span><span class="op">&lt;</span>any<span class="op">&gt;</span> <span class="op">=</span> <span class="va">d3</span>.<span class="at">select</span>(<span class="kw">this</span>)<span class="op">;</span>

            <span class="co">// Prepare data for ticks</span>
            <span class="kw">const</span> ticksData <span class="op">=</span> <span class="va">data</span>.<span class="at">sort</span>((a<span class="op">,</span> b) <span class="op">=&gt;</span> <span class="at">Number</span>(a) <span class="op">-</span> <span class="at">Number</span>(b))
                .<span class="at">reduce</span>((acc<span class="op">,</span> d) <span class="op">=&gt;</span> <span class="op">{</span>
                    <span class="kw">const</span> latestWithText <span class="op">=</span> <span class="at">last</span>(<span class="va">acc</span>.<span class="at">withText</span>)<span class="op">;</span>

                    <span class="co">// skip duplicates immediately</span>
                    <span class="cf">if</span> (latestWithText <span class="op">&amp;&amp;</span> latestWithText <span class="op">===</span> d) <span class="op">{</span> <span class="cf">return</span> acc<span class="op">;</span> <span class="op">}</span>

                    <span class="co">// for first or not too close we add text one</span>
                    <span class="cf">if</span> (<span class="op">!</span>latestWithText <span class="op">||</span> <span class="va">Math</span>.<span class="at">abs</span>(<span class="at">scale</span>(latestWithText) <span class="op">-</span> <span class="at">scale</span>(d)) <span class="op">&gt;=</span> TEXT_DELTA) <span class="op">{</span>
                        <span class="va">acc</span>.<span class="va">withText</span>.<span class="at">push</span>(d)<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        <span class="co">// we add tick without text</span>
                        <span class="kw">const</span> latestWithoutText <span class="op">=</span> <span class="at">last</span>(<span class="va">acc</span>.<span class="at">withoutText</span>)<span class="op">;</span>

                        <span class="co">// check for delta from latest with text</span>
                        <span class="cf">if</span> (<span class="va">Math</span>.<span class="at">abs</span>(<span class="at">scale</span>(latestWithoutText) <span class="op">-</span> <span class="at">scale</span>(d)) <span class="op">&gt;=</span> WITHOUT_TEXT_DELTA) <span class="op">{</span>

                            <span class="co">// check for delta from latest without text</span>
                            <span class="cf">if</span> (<span class="op">!</span>latestWithoutText <span class="op">||</span> <span class="va">Math</span>.<span class="at">abs</span>(<span class="at">scale</span>(latestWithoutText) <span class="op">-</span> <span class="at">scale</span>(d)) <span class="op">&gt;=</span> WITHOUT_TEXT_DELTA) <span class="op">{</span>
                                <span class="va">acc</span>.<span class="va">withoutText</span>.<span class="at">push</span>(d)<span class="op">;</span>
                            <span class="op">}</span>
                        <span class="op">}</span>
                    <span class="op">}</span>

                    <span class="cf">return</span> acc<span class="op">;</span>
                <span class="op">},</span> <span class="op">{</span> <span class="dt">withText</span><span class="op">:</span> []<span class="op">,</span> <span class="dt">withoutText</span><span class="op">:</span> [] <span class="op">}</span> )<span class="op">;</span>

                <span class="co">// Render</span>

                <span class="co">// With text</span>
                <span class="kw">const</span> withText <span class="op">=</span> <span class="va">g</span>.<span class="at">selectAll</span>(<span class="st">'.tick.tick--with-text'</span>).<span class="at">data</span>(<span class="va">ticksData</span>.<span class="at">withText</span>)<span class="op">;</span>
                <span class="va">withText</span>.<span class="at">enter</span>().<span class="at">append</span>(<span class="st">'g'</span>)
                    .<span class="at">attr</span>(<span class="st">'class'</span><span class="op">,</span> <span class="st">'tick tick-with-text'</span>)
                    .<span class="at">append</span>(<span class="st">'text'</span>)
                    .<span class="at">style</span>(<span class="st">'text-anchor'</span><span class="op">,</span> <span class="st">'middle'</span>)<span class="op">;</span>
                <span class="va">withText</span>.<span class="at">transition</span>()
                    .<span class="at">attr</span>(<span class="st">'transform'</span><span class="op">,</span> d <span class="op">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="at">scale</span>(d)<span class="op">,</span> <span class="dv">15</span><span class="sc">}</span><span class="vs">)`</span>)
                    .<span class="at">select</span>(<span class="st">'text'</span>)
                    .<span class="at">text</span>(tickFormat)<span class="op">;</span>

                <span class="va">withText</span>.<span class="at">exit</span>().<span class="at">remove</span>()<span class="op">;</span>

                <span class="co">// Without text</span>
                <span class="kw">const</span> withoutText <span class="op">=</span> <span class="va">d3</span>.<span class="at">selectAll</span>(<span class="st">'.tick.tick--without-text'</span>).<span class="at">data</span>(<span class="va">ticksData</span>.<span class="at">withoutText</span>)<span class="op">;</span>
                <span class="va">withoutText</span>.<span class="at">enter</span>().<span class="at">append</span>(<span class="st">'g'</span>)
                    .<span class="at">attr</span>(<span class="st">'class'</span><span class="op">,</span> <span class="st">'tick tick-without-text'</span>)
                    .<span class="at">append</span>(<span class="st">'line'</span>)
                    .<span class="at">attr</span>(<span class="st">'x1'</span><span class="op">,</span> <span class="dv">0</span>)
                    .<span class="at">attr</span>(<span class="st">'x2'</span><span class="op">,</span> <span class="dv">0</span>)
                    .<span class="at">attr</span>(<span class="st">'y1'</span><span class="op">,</span> <span class="dv">0</span>)
                    .<span class="at">attr</span>(<span class="st">'y2'</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span>
                <span class="va">withoutText</span>.<span class="at">transition</span>()
                    .<span class="at">attr</span>(<span class="st">'transform'</span><span class="op">,</span> d <span class="op">=&gt;</span> <span class="vs">`trnaslate(</span><span class="sc">${</span><span class="at">scale</span>(d)<span class="sc">}</span><span class="vs">, 0)`</span>)<span class="op">;</span>
                <span class="va">withoutText</span>.<span class="at">exit</span>().<span class="at">remove</span>()<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Public Interface</span>

    <span class="va">tip</span>.<span class="at">scale</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">newScale </span><span class="op">:</span> <span class="va">d3</span>.<span class="va">scale</span>.<span class="at">Ordinal</span><span class="op">&lt;</span>any<span class="op">,</span> any<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        scale <span class="op">=</span> newScale<span class="op">;</span>
        <span class="cf">return</span> tip<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">tip</span>.<span class="at">data</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">d </span><span class="op">:</span> T[]) <span class="op">{</span>
        data <span class="op">=</span> d<span class="op">;</span>
        <span class="cf">return</span> tip<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">tip</span>.<span class="at">tickFormat</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">fc </span><span class="op">:</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        tickFormat <span class="op">=</span> fc<span class="op">;</span>
        <span class="cf">return</span> tip<span class="op">;</span>
    <span class="op">}</span>

    <span class="cf">return</span> tip<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p><em>Note: If you read carefully you know that I’m not using <code>this</code> often. However for this example has one usage of <code>this</code> to get element in d3’s <code>each</code> method. It doesn’t make sense to go against library API.</em></p>
<p><em>Note: This is really simplified implementation. Actual thing similar to this we have in our lib uses 3 types of ticks (long text, short text, no text). This means also different interface for <code>FormatValue</code> an we are also always adding line tip (without text) in middle of tips with text. However I think this simpler example is better for purpose of this article.</em></p>
<h2 id="dont-drink-too-much-kool-aid">Don’t Drink Too Much Kool-Aid</h2>
<p>TypeScript maybe lets you express these kind of dynamic APIs but there is down side to it. If you remove implementation for any method compiler won’t complain even though your function does not return valid <code>ExactTip&lt;T&gt;</code> implementation. However if you make mistake in method implementation (change its types) it will fail during compile time which seems as an improvement to pure JS version. That said if you want to play with something like this It’s usually good idea to <strong>always start with boilerplate with all methods defined</strong>.</p>


<div class="reddit-discussion">
  <img src="../assets/reddit.png" alt="redit" class="reddit-logo">
  Since I'm not a fan of disqus or any other commenting system so there is no disscusion under this post.<br>
  However I do like reddit as a platform so feel free to shout here:<br>
  <a href="https://www.reddit.com/r/typescript/comments/5h15an/hybrid_types_in_typescript">r/typescript/comments/5h15an/hybrid_types_in_typescript</a>
</div>


      </div>
      <div id="footer">
        <a href="https://github.com/turboMaCk/turboMaCk.github.io">Source</a> available under BSD-3-Clause.<br>
        Content is pubished under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.<br>
        Proudly powered by <a href="http://jaspervdj.be/hakyll">Hakyll</a>; Theme by Marek Fajkus
      </div>
    </main>
  </body>
</html>
