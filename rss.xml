<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>turbo_MaCk - All posts</title>
        <link>http://turbomack.github.iuo</link>
        <description><![CDATA[Personal website of turbo_MaCk]]></description>
        <atom:link href="http://turbomack.github.iuo/rss.xml" rel="self"
                   type="application/rss+xml" />
        <lastBuildDate>Sun, 09 Apr 2017 00:00:00 UT</lastBuildDate>
        <item>
    <title>Deeper Dive To (Tail) Recursion - 2 Tail Calls</title>
    <link>http://turbomack.github.iuo/posts/2017-04-09-tail-recursion.html</link>
    <description><![CDATA[<p>In <a href="./2017-02-12-recursion.html">part #1</a> of this series I wrote about reasons why I think recursion is important and try to reevaluate on this topic a bit. This time I would like to finally focus on <strong>tail recursion</strong> itself.</p>
<p><strong>Note:</strong> One of occasions I’ve been discussing tail recursion was when I was staying in hotel in London with one of my colleagues. Original conversation we had was about <a href="https://en.wikipedia.org/wiki/Prolog">Prolog</a> therefor I’ve wrote original examples in Erlang (since I don’t know Prolog at all but know that Erlang’s syntax is based on it). Anyway I’ll also add few examples in other languages to make this article a bit more interesting.</p>
<h1 id="tail-recursion">Tail Recursion</h1>
<p>If you’re interested in proper definition tail recursion have a look at <a href="https://en.wikipedia.org/wiki/Tail_call">wikipedia article</a>. To translate this definition to other language you might find easier to understand we can go back to recursion itself. In <a href="./2017-02-12-recursion.html">previous part</a> we said that recursion means self reference - speaking about functions we can simply say that it’s function which calls itself internally. One thing that might be confusing is term “tail recursion” itself. In article about recursion we were often using functions for manipulating linked list. This makes sense because list is useful and simple recursive datastructure. However as you might know list are defined as being either empty (<code>nil</code>) or <code>head cons tail</code> where tail is other list (the one without head). I’ve intentionally used some examples using term (variable) <code>tail</code> in previous article just to make it clear that using tail of list doesn’t automatically mean your implementation is tail recursive. <strong>Tail recursion and tail of linked List are two completely unrelated things</strong>. Honestly I don’t know where <code>tail recursion</code> name comes from and even though I believe there are some reasons for calling it <em>tail</em> I think it only causes confusion. Another misunderstanding I think is pretty often is folks thinking that every function containing recursive statement on literally “last line” is tail recursive - It’s not. Let’s leave lazy languages like haskell aside and think just about execution of something like <code>length(list) = 1 + length(tail(list))</code> - You can’t add <code>1</code> before you calculate <code>length(tail(list))</code>, right?</p>
<p><strong>Tail recursive function is function where recursive call is very last (from execution point of view) expression within that function</strong>. This means that there is nothing left to do when recursion finish and result of recursive call is also result of parent scope (you don’t need to do anything like `add 1` to result of recursive call). In such cases compilers can implement optimization so parent function “exits” and recursive calls takes its place in stack. Almost like loop, right?</p>
<p>There is also one other way I like to think about this - Tail recursive is actually just calculating arguments for next recursive call until up to the point where it can calculate final result without any other recursive call.</p>
<h1 id="optimization">Optimization</h1>
<p>One think worth mentioning is that writing tail recursive code doesn’t automatically means that tail recursive optimization takes place. Optimization step depends on compiler. Generally every language with decent functional support (by decent I mean every language that isn’t necessary <a href="https://en.wikipedia.org/wiki/Pattern_matching">pure</a> but claims to have at least partial functional paradigm support) has this optimization build-in. Also I would like to mention two controversial platforms. <strong>JavaScript is not yet capable of such optimization</strong> even despite promises of including this to ECMA standard was made a long time ago. However languages like PureScript, Elm or ghcjs does this optimization in compile time for you (generated JS uses loops). On JVM situation is quite similar. There <a href="https://www.youtube.com/watch?v=_ahvzDzKdB0">were attempts</a> to add this optimization to Java which are in some sense still actual. Yet JVM doesn’t have this optimization yet. Scalac (Scala’s compiler) can optimize you’re code in compile time (you need to add <code>@tailrec</code> annotation). On the other hand Clojure has construct called <a href="https://clojuredocs.org/clojure.core/recur">recur</a> to go around absence of support on VM level.</p>
<h1 id="writing-tail-recursive-code">Writing Tail Recursive Code</h1>
<p>Rewriting recursive functions to tail recursive ones may seem to be a bit hard at first. Anyway from my experience it might be different from case to case and after some practice (of brain) it might feel even simpler to think in tail recursion out of the box. However I agree this is not true for every recursive algorithm and sometimes it requires some effort. That say it might seem that some points I made in previous article about recursion being ultimate technique over loops were bit misleading. Honestly I still think complicated tail recursion is still easier to understand and more importantly much easier to reason about than complex loops.</p>
<h2 id="examples">Examples</h2>
<p>Let’s have a look on few examples of how we can turn recursive function to tail recursive one.</p>
<h3 id="factorial">Factorial</h3>
<p>This is one if basic implementations of <a href="https://en.wikipedia.org/wiki/Factorial">factorial</a> in Erlang.</p>
<div class="sourceCode"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="kw">-module</span><span class="fu">(</span><span class="ch">fac</span><span class="fu">).</span>

<span class="kw">-export</span><span class="fu">([</span><span class="ch">fac</span><span class="op">/</span><span class="dv">1</span><span class="fu">]).</span>

<span class="co">%% Basic recursive implementation of factorial</span>
<span class="fu">fac(</span><span class="dv">0</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="dv">1</span><span class="fu">;</span>
<span class="fu">fac(</span><span class="va">N</span><span class="fu">)</span> <span class="ch">when</span> <span class="va">N</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">-&gt;</span>
    <span class="va">N</span> <span class="op">*</span> <span class="fu">fac(</span><span class="va">N</span> <span class="op">-</span> <span class="dv">1</span><span class="fu">).</span></code></pre></div>
<p>Obviously this implementation <strong>is not</strong> tail recursive. Last expression evaluated is <code>*</code> with <code>N</code> and result of recursive call <code>fac(N - 1)</code>. Lets change that. To do so we will use another “private function” which will take one more argument. This argument is often called <strong>accumulator</strong> since it’s used for storing intermediate results. Let’s look of final implementation since it says more than thousand words.</p>
<div class="sourceCode"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="kw">-module</span><span class="fu">(</span><span class="ch">tail_fac</span><span class="fu">).</span>

<span class="kw">-export</span><span class="fu">([</span><span class="ch">tail_fac</span><span class="op">/</span><span class="dv">1</span><span class="fu">]).</span>

<span class="co">%% Tail recursive factorial - public function</span>
<span class="fu">tail_fac(</span><span class="va">N</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="fu">tail_fac(</span><span class="va">N</span><span class="fu">,</span> <span class="dv">1</span><span class="fu">).</span>

<span class="co">%% Actual private tail recursive implementation</span>
<span class="fu">tail_fac(</span><span class="dv">0</span><span class="fu">,</span> <span class="va">Acc</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="va">Acc</span><span class="fu">;</span>
<span class="fu">tail_fac(</span><span class="va">N</span><span class="fu">,</span> <span class="va">Acc</span><span class="fu">)</span> <span class="ch">when</span> <span class="va">N</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">-&gt;</span>
    <span class="fu">tail_fac(</span><span class="va">N</span> <span class="op">-</span> <span class="dv">1</span><span class="fu">,</span> <span class="va">Acc</span> <span class="op">*</span> <span class="va">N</span><span class="fu">).</span></code></pre></div>
<p>As you can see Erlang is good fir for example like this due to fact that function is <a href="http://stackoverflow.com/questions/21315927/why-does-erlang-have-arity-in-its-imports">define for particular arity</a>. This mean we can use same name for function that takes one (<code>tail_fac/1</code>) and two (<code>tail_fac/2</code>) arguments and use them as they were completely different functions. Also we can expose just one of them.</p>
<p>As you can see <code>tail_fac/1</code> just calls <code>tail_fac/2</code> with initial accumulator <code>1</code>. We can say that this is just initialization for call to <code>tail_fac/2</code>. <code>tail_fac/2</code> on the other hand returns <code>Acc</code> when <code>N == 0</code>. The way I like to think about this is that we’ve changed the direction in which we compute factorial. Instead of starting from <code>1</code> we start from <code>N</code>. Let’s say we’re evaluating <code>tail_fac(3)</code>. This calls <code>tail_fac/2</code> with <code>N = 3</code> and <code>Acc = 0</code>. <code>N * Acc</code> then is <code>3 * 1</code> which is <code>3</code>. This is just “identity” of N so if we say <code>3! = 3 * 2 * 1</code> this calculates first just <code>3</code> as initial value. Also you can thing that what we actually did is rewrite factorial as <code>3! = ((1 * 3) * 2) * 1)</code> so each sub expression has 2 arguments. <code>N</code> on the other hands keeps track of how many times we need to keep going. In next call <code>N = 2</code> and <code>Acc = 3</code>. We call recursively one more time with <code>N = 1</code> and <code>Acc = 3 * 2 = 6</code>. In next recursive call <code>N = 0</code> and <code>Acc = 6 * 1 = 6</code>. Now we match first pattern (<code>tail_fac(0, Acc)</code>) and just return <code>Acc</code> which is our result - <strong>6</strong>.</p>
<p>As you can see we last call with <code>N = 1</code> is not necessary because <code>n * 1 = n</code>. This means we can add small optimization to our code like:</p>
<div class="sourceCode"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="co">%% Actual private tail recursive implementation</span>
<span class="fu">tail_fac(</span><span class="va">N</span><span class="fu">,</span> <span class="va">Acc</span><span class="fu">)</span> <span class="ch">when</span> <span class="va">N</span> <span class="op">&lt;</span> <span class="dv">2</span> <span class="op">-&gt;</span> <span class="va">Acc</span><span class="fu">;</span>
<span class="fu">tail_fac(</span><span class="va">N</span><span class="fu">,</span> <span class="va">Acc</span><span class="fu">)</span> <span class="ch">when</span> <span class="va">N</span> <span class="op">&gt;</span> <span class="dv">1</span> <span class="op">-&gt;</span>
    <span class="fu">tail_fac(</span><span class="va">N</span> <span class="op">-</span> <span class="dv">1</span><span class="fu">,</span> <span class="va">Acc</span> <span class="op">*</span> <span class="va">N</span><span class="fu">).</span></code></pre></div>
<p>so we can return on N = 1 without extra recursive call.</p>
<h3 id="length">Length</h3>
<p>Now let’s have a look on length implementation. We already know this function for previous article. This is basic recursive implementation:</p>
<div class="sourceCode"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="kw">-module</span><span class="fu">(length).</span>

<span class="kw">-export</span><span class="fu">([length</span><span class="op">/</span><span class="dv">1</span><span class="fu">]).</span>

<span class="co">%% Basic implementation of length</span>
<span class="fu">length([])</span> <span class="op">-&gt;</span> <span class="dv">0</span><span class="fu">;</span>
<span class="fu">length([</span>_<span class="fu">])</span> <span class="op">-&gt;</span> <span class="dv">1</span><span class="fu">;</span>
<span class="fu">length([</span>_<span class="fu">|</span><span class="va">T</span><span class="fu">])</span> <span class="op">-&gt;</span> <span class="dv">1</span> <span class="op">+</span> <span class="fu">length(</span><span class="va">T</span><span class="fu">).</span></code></pre></div>
<p>This really looks much better than our previous attempt in JS (and also this is not broken). How this works? Simply - for empty list (btw [] is List in Erlang if I haven’t mention this before) is 0. For list with just one element the length is 1. For any other list it’s 1 + length of previous list. Say we have list like <code>[1,2,3]</code>. length of this list is <code>1 + (length([2,3]))</code> -&gt; <code>1 + (1 + length([3]))</code> -&gt; <code>1 + (1 + 1)</code> -&gt; <code>1 + 2</code> -&gt; <code>3</code>. Let’s make this tail recursive.</p>
<div class="sourceCode"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="kw">-module</span><span class="fu">(</span><span class="ch">tail_length</span><span class="fu">).</span>

<span class="kw">-export</span><span class="fu">([</span><span class="ch">tail_length</span><span class="op">/</span><span class="dv">1</span><span class="fu">]).</span>

<span class="co">%% Tail recursive length - public function</span>
<span class="fu">tail_length(</span><span class="va">L</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="fu">tail_length(</span><span class="va">L</span><span class="fu">,</span> <span class="dv">0</span><span class="fu">).</span>

<span class="co">%% Actual private tail recursive implementation</span>
<span class="fu">tail_length([],</span> _<span class="fu">)</span> <span class="op">-&gt;</span> <span class="dv">0</span><span class="fu">;</span>
<span class="fu">tail_length([</span>_<span class="fu">],</span> <span class="va">Acc</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="va">Acc</span> <span class="op">+</span> <span class="dv">1</span><span class="fu">;</span>
<span class="fu">tail_length([</span>_<span class="fu">|</span><span class="va">T</span><span class="fu">],</span> <span class="va">Acc</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="fu">tail_length(</span><span class="va">T</span><span class="fu">,</span> <span class="va">Acc</span> <span class="op">+</span> <span class="dv">1</span><span class="fu">).</span></code></pre></div>
<p>Once again I like to think about this as like calculation from other end. In previous example we calculated length of 3 element list by constructing expression containing sub expression of length calculation for each tail and evaluating it. There is certainly nothing bad about it from mathematical point of view. However our machines have certain attributes and limitations (like time and space). How tail recursive implementation works? Instead of calculating length of list’s tail first we calculate lenght of heads and continue by adding lenght of next head up to the point there is nothing left. If this sound confusing don’t worry. Just follow this computation with me.</p>
<p>Again lets assume we have list <code>[1,2,3]</code>. <code>tail_length/1</code> acts just like public interface (initializer) for our private implementation so actual call is to <code>tail_lenght/2</code> which looks like <code>tail_length([1,2,3], 0)</code>. What we do next is to calculate length up to this point by adding intermediate (<code>Acc</code>) result to result for current head - <code>0 + 1</code>. Since we don’t have lenght for any element yet we pass 0 in intial call (you can think this is length of empty list if you wish). Ok so length of heads up to this point is <code>1</code> (0 + 1). Then we need calculate length of tail in next call <code>tail_length([2,3], 1)</code>. See that there is nothing we have wait for? Result of this expression is just result of recursive call. This is why compiler is able to optimize this under the hood. Let’s continue. Next call will look like this <code>tail_length([3], 1 + 1) = tail_length([3], 2)</code> because length of head is always one we just need to add 1 to length of previous heads every time we don’t match empty list. And finally last call matches 2 cause which evaluates <code>2 + 1 = 3</code> and this is our result.</p>
<p><strong>Note:</strong> You can see I’m using term <code>tail</code> a lot. Once again this has nothing to do with tail-recursion itself but rather with list we are using in examples. This might be a bit confusing but even though recursion is common while working with lists it’s really not the only place where we are speaking about (tail) recursion. This is why I used factorial as first example.</p>
<p>So far we have 2 nice little examples of tail recursion in Erlang. However you can easily transform all of this to any other language (even to one which has no tail recursive optimization build in if you want - but don’t expect any better characteristics than). Of course every language has it’s own specifics. Let’s have a look of possible Haskell implementation.</p>
<p>Notice that Haskell’s pattern matching is slightly different. In Erlang there were 3 patterns to match list - <code>[]</code> for empty list (nil), <code>[x]</code> for list with one element and <code>[H|T]</code> for list with more elements (Head and Tail). In Haskell you need just 2 patterns since list with one element (just head) is list with head and empty list as tail - <code>head:[]</code>. With this in mind lets have a look at actual code.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">Length</span>(length) <span class="kw">where</span>

length<span class="ot"> ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Int</span>
length <span class="fu">=</span> length&#39; <span class="dv">0</span>

<span class="ot">length&#39; ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Int</span>
length&#39; acc [] <span class="fu">=</span> acc
length&#39; acc (h<span class="fu">:</span>t) <span class="fu">=</span> length&#39; (acc <span class="fu">+</span> <span class="dv">1</span>) t</code></pre></div>
<p>You can notice few other differences from previous example. First we are using prime (~’~) in name of private function. Also the order of arguments is different. Since Haskell is using <a href="https://en.wikipedia.org/wiki/Currying">currying</a> this order of arguments seems to be more logic. This is nice example of how language features might affect the way you design your API to make its usage convenient. However we’re not hear to speak about neither language features nor currying. You can find plenty of articles to learn more about both.</p>
<p>Recursive functions for data-structures like list have one interesting property. There is really a lot of useful functions like <code>map</code>, <code>filter</code>, <code>length</code>, <code>zip</code>, <code>sum</code> and similar. What they have in common? Try to think about possible implementation. You always initialize them with some value. This value is of the same type as result of recursive call. And then you go over all elements inside this data-structure. In fact this pattern is so common that it has it’s own name and abstraction in almost every language (at least one with higher order functions). This is called <a href="https://en.wikipedia.org/wiki/Fold_(higher-order_function)">folding</a>. You might know this as <code>folder</code> <code>foldl</code> or <code>reduce</code> function in your language. Also you’re maybe familiar with fancy buzzword thing called <a href="https://en.wikipedia.org/wiki/MapReduce">MapReduce</a>. Fun fact - Map is just one specific type of reduced. Term “map-reduce” is in that sense like saying “paint<sub>inred</sub>-paint<sub>incolor</sub>”. Anyway this name makes some sense since due to distributed nature of such systems <code>map</code> is type of reducer you can run in parallel (in distribution) and then you reduce all collected data way you want.</p>
<p>In next (and last) part of this series of articles I want to dedicate just to folding. Anyway for now let me show you one more example. Next algorithm can is recursive but can’t be implemented using folding.</p>
<h3 id="fibonacci-number">Fibonacci Number</h3>
<p>Fibonacci numbers are highly overused example for recursive algorithms. You probably saw it dozen times so here it’s once again:</p>
<div class="sourceCode"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="kw">-module</span><span class="fu">(</span><span class="ch">fib</span><span class="fu">).</span>

<span class="kw">-export</span><span class="fu">([</span><span class="ch">fib</span><span class="op">/</span><span class="dv">1</span><span class="fu">]).</span>

<span class="fu">fib(</span><span class="dv">0</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="dv">0</span><span class="fu">;</span>
<span class="fu">fib(</span><span class="dv">1</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="dv">1</span><span class="fu">;</span>
<span class="fu">fib(</span><span class="va">N</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="fu">fib(</span><span class="va">N</span> <span class="op">-</span> <span class="dv">2</span><span class="fu">)</span> <span class="op">+</span> <span class="fu">fib(</span><span class="va">N</span> <span class="op">-</span> <span class="dv">1</span><span class="fu">).</span></code></pre></div>
<p>And the most slides on conferences ends right here. For example <a href="http://www.youtube.com/watch?v=5hDVftaPQwY&amp;t=7m15s">this one</a> by “Pragmatic Dave Thomas”.</p>
<p>I really don’t want to undermine mr. Thomas in any way but this is how same thing looks like in Ruby:</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> fib(n)
  <span class="kw">return</span> <span class="dv">0</span> <span class="kw">if</span> n == <span class="dv">0</span>
  <span class="kw">return</span> <span class="dv">1</span> <span class="kw">if</span> n == <span class="dv">1</span>
  fib(n-<span class="dv">1</span>) + fib(n-<span class="dv">2</span>)
<span class="kw">end</span></code></pre></div>
<p>Doesn’t look so different to me¯_(ツ)_/¯. Even though more ruby-like implementation would be probably:</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">class</span> <span class="dt">Integer</span>
  <span class="kw">def</span> fib
    <span class="kw">return</span> <span class="dv">0</span> <span class="kw">if</span> <span class="dv">self</span> == <span class="dv">0</span>
    <span class="kw">return</span> <span class="dv">1</span> <span class="kw">if</span> <span class="dv">self</span> == <span class="dv">1</span>
    (<span class="dv">self</span> - <span class="dv">1</span>).fib + (<span class="dv">self</span> - <span class="dv">2</span>).fib
  <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<p>So then you can use it like <code>10.fib =&gt; 55</code>.</p>
<p>Anyway the reason I’m showing you Fibonacci number is because you need to know 2 previous results to calculate next number in sequence. It turned out that a lot of people found it difficult to transform this to tail recursive implementation. In fact it’s fairly simple! Just use two accumulators instead of one!</p>
<div class="sourceCode"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="kw">-module</span><span class="fu">(</span><span class="ch">tail_fib</span><span class="fu">).</span>

<span class="kw">-export</span><span class="fu">([</span><span class="ch">tail_fib</span><span class="op">/</span><span class="dv">1</span><span class="fu">]).</span>

<span class="fu">tail_fib(</span><span class="dv">0</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="dv">0</span><span class="fu">;</span>
<span class="fu">tail_fib(</span><span class="dv">1</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="dv">1</span><span class="fu">;</span>
<span class="fu">tail_fib(</span><span class="va">N</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="fu">tail_fib(</span><span class="va">N</span> <span class="op">-</span> <span class="dv">2</span><span class="fu">,</span> <span class="dv">0</span><span class="fu">,</span> <span class="dv">1</span><span class="fu">).</span>

<span class="fu">tail_fib(</span><span class="dv">0</span><span class="fu">,</span> <span class="va">Acc1</span><span class="fu">,</span> <span class="va">Acc2</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="va">Acc1</span> <span class="op">+</span> <span class="va">Acc2</span><span class="fu">;</span>
<span class="fu">tail_fib(</span><span class="va">N</span><span class="fu">,</span> <span class="va">Acc1</span><span class="fu">,</span> <span class="va">Acc2</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="fu">tail_fib(</span><span class="va">N</span> <span class="op">-</span> <span class="dv">1</span><span class="fu">,</span> <span class="va">Acc2</span><span class="fu">,</span> <span class="va">Acc1</span> <span class="op">+</span> <span class="va">Acc2</span><span class="fu">)</span></code></pre></div>
<p>That’s it! Principle is still the same just applied to different problem. I’m not going to go through evaluation once again so take this as exam if you want.</p>
<h1 id="final-thoughts">Final thoughts</h1>
<p>I hope now you have better understanding what tail recursion is, how it works and how to write your own tail recursive functions. However in most cases you don’t really need to implement everything we did in this article. For instance our length function can be written in much less code using just one simple level of abstraction - <code>foldr</code>, <code>foldl</code> or <code>reduce</code> or <a href="https://en.wikibooks.org/wiki/Haskell/Foldable">Foldable</a> if you want. More about this next time. Peace.</p>]]></description>
    <pubDate>Sun, 09 Apr 2017 00:00:00 UT</pubDate>
    <guid>http://turbomack.github.iuo/posts/2017-04-09-tail-recursion.html</guid>
    <dc:creator>Marek Fajkus</dc:creator>
</item>
<item>
    <title>Deep Dive To (Tail) Recursion - 1 Intro</title>
    <link>http://turbomack.github.iuo/posts/2017-02-12-recursion.html</link>
    <description><![CDATA[<p>From time to time someone raises concern about performance of recursive algorithms in some of many conversations I have with my colleagues, friends and folks from local meetup groups. Even though this might seem to be clear to people with certain level of functional programming experience it’s certainly not generally well understood topic. I’ve found that there is a lot of confusion going around and some folks seems to be pretty scared when you pull all that weird terminology right of the box. This is why I still think it’s worth spending some time exploring what recursion and tail recursion really means and how you can use both in practice.</p>
<h1 id="recursion">Recursion</h1>
<p>Recursion can be found in many areas of mathematics and computer science. There are some examples:</p>
<h3 id="shell">Shell</h3>
<pre class="shell"><code>rm -r folder_name
</code></pre>
<p>where <code>-r</code> means apply command <code>rm</code> recursively to all sub files and sub folders.</p>
<h3 id="algorithms">Algorithms</h3>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">length</span>(arr) <span class="op">{</span>
    <span class="cf">if</span> (<span class="op">!</span>arr[<span class="dv">0</span>]) <span class="op">{</span>
        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>
    <span class="op">}</span>
    <span class="va">arr</span>.<span class="at">pop</span>()<span class="op">;</span>

    <span class="cf">return</span> <span class="dv">1</span> <span class="op">+</span> <span class="at">length</span>(arr)<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>where function contains call to itself.</p>
<p><strong>Note:</strong> <code>length()</code> implementation is just used for demonstration purposes. Please don’t try to use it in real world! There are many problems with the code above. Performance will be really bad and also function will cause mutations in original array which becomes empty after being passed to the function due to <code>pop()</code> call! If you thinking about using something similar in your code base <code>fuckUpLength</code> would be probably better name for such function.</p>
<h3 id="algebraic-data-types">Algebraic Data Types</h3>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">RoseTree</span> a <span class="fu">=</span> <span class="dt">Node</span> a [<span class="dt">RoseTree</span> a]</code></pre></div>
<p>where type definition might be recursive (type containing itself)</p>
<h3 id="sequences">Sequences</h3>
<p>For instance our friend Fibonacci</p>
<p><br /><span class="math display">$$ \begin{align*}
  F_0 &amp;= 0, \\
  F_1 &amp;= 1, \\
  F_n &amp;= F_{n-1} + F_{n-2}
\end{align*}
$$</span><br /></p>
<p>where fibonnaci n is define in terms of fibbonaci n-1 and fibbonaci n-2.</p>
<h3 id="yo-man-i-heard-you-like">Yo man I heard you like…</h3>
<p>Even though these three might seem completely unrelated it’s super important to understand that underlaying concept is same.</p>
<p>Let’s use <code>rm</code> example for instance. This command executes itself for every sub-folder of folder it’s executed. This simple principle allows <code>rm</code> to work with any depth of directories in file system.</p>
<p>More generally <strong>recursion is property of self-reference</strong>. Acronym “GNU” Gnu’s Not Unix is refering to itself (G stays for GNU itself). Therefore we call such acronym <a href="https://en.wikipedia.org/wiki/Recursive_acronym">recursive acronym</a>.</p>
<p>You can have a look at <a href="https://en.wikipedia.org/wiki/Recursion">wikipedia</a> where you can find more in case you’re interested.</p>
<p><img src="http://s2.quickmeme.com/img/a7/a764b1ed93f5fae80373f990de499c79ef0e2b0b3f950cb6b42ed9294de3b947.jpg" /></p>
<h1 id="loops">Loops</h1>
<p>Loops are fairly popular technique used in place of recursion in many programs. It’s quite important to understand that loops are workaround for underlaying recursive nature of program or algorithm. The idea is simple - instead of dealing with function calling itself we loop sequence of “instructions” over data. In some sense loops are just restrictive abstraction over <code>GOTO</code> but core idea stays same. Program checks some condition (like <code>i &lt; arr.length</code>) proceed some instructions, apply some mutation to data it started with (eg. <code>i++</code>) and <code>GOTO</code> condition again to either executes instructions with new state or exists subroutine if condition is not satisfied.</p>
<p>This solves problem with stack overflow - function can’t return (exit) until all its sub-calls (recursive calls) return) and is generally much closer to what we want hardware to do than recursion itself. Let’s rewrite <code>length()</code> implementation from previous examples using loop.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">length</span>(arr) <span class="op">{</span>
    <span class="kw">var</span> len <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>
    <span class="cf">while</span>(arr[<span class="dv">0</span>]) <span class="op">{</span>
      len<span class="op">++;</span>
      <span class="va">arr</span>.<span class="at">pop</span>()
    <span class="op">}</span>

    <span class="cf">return</span> len<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p><strong>Note:</strong> Even this implementation of length is bad. Function still performs mutation on array using <code>pop()</code>. Please do not use such code for anything but learning.</p>
<p>Loops are so widely used technique that many programmers kind of defaults to it. This is probably because most widely used languages derives more or less from C (think about C++, Java, C#, JavaScript…). Anyway I would say this is huge tradeoff. Translating algorithm for machine is hard and when people writing programs starts to think as machine they quite often miss general logic in program (Tend to solves adhock cases here and there instead abstracting concepts to composable pieces). Even it might seem easier to use loops over recursion to most developers it’s definitely not easier when it comes to more complex algorithms or design of large systems.</p>
<p>There are so many things that can go wrong in simple <code>for</code> loop that it’s even not worth trying to list them. Concept of loops also heavily relies on mutations which are hard to deal with especially when concurrency (in multithreaded environment) is involved. This is nothing new. Even imperative languages introduced many concepts to address issues like this like for example <a href="https://en.wikipedia.org/wiki/Iterator">iterators</a> which I’m not really going to cover in this article but you can find tons of material about them on <a href="https://duckduckgo.com/?q=iterator">the internet</a>.</p>
<p>Nevertheless I still think that recursion over power any other concept and should be the thing we defaults to instinctively when thinking about problem.</p>
<p>Even most <a href="https://en.wikipedia.org/wiki/Dynamic_programming">dynamic programming</a> practices often starts with recursive definition and translates that implementation to loop just to gain better performance characteristics later.</p>
<p><strong>Note:</strong> In case you’re interested learning more about dynamic programming I recommend to look at <a href="https://www.youtube.com/watch?v=OQ5jsbhAv_M&amp;list=PLfMspJ0TLR5HRFu2kLh3U4mvStMO8QURm">MIT’s public Introduction to Algorithms</a>.</p>
<p>There is still one issue using technique like dynamic programming in my opinion. Once you optimize code to loops it’s stay that way. This means every time you or anyone else will need to tweak something in you’re code youl’ll need to walk through code you was no able to put down from head in first place. You can imagine this won’t be pleasing experience. Wouldn’t it be nice to have recursive implementation and hand optimization to compiler instead?</p>
<p>Good news folks! There are compilers capable of such optimization out there! The only requirement on your side is to keep your implementation <a href="https://en.wikipedia.org/wiki/Tail_call">tail recursive</a>!</p>
<p>We will look what this mean and how you can use it in <a href="./2017-04-09-tail-recursion.html">next part</a>. Till then let force be with you my friends.</p>]]></description>
    <pubDate>Sun, 12 Feb 2017 00:00:00 UT</pubDate>
    <guid>http://turbomack.github.iuo/posts/2017-02-12-recursion.html</guid>
    <dc:creator>Marek Fajkus</dc:creator>
</item>
<item>
    <title>From Vim to Emacs - Year Later</title>
    <link>http://turbomack.github.iuo/posts/2016-12-29-from-vim-to-emacs-year-later.html</link>
    <description><![CDATA[<p>It’s been about a year since I’ve switched from my highly customized vim to Emacs as a default editor. I have to admit it I had sometimes pretty tough times with Emacs especially at the beginnings. Anyway at the same time I’ve found it really beneficial and have significant impact on my current workflow. This article isn’t meant in any sense to be tutorial to neither Emacs nor Vim but is rather a reasoning about my experience and recapitulation of what I’ve learned during past year. Can it really help someone? I don’t know. But I still feel it’s worth putting those ideas down.</p>
<h1 id="why-would-anyone-possibly-want-to-do-this">Why Would Anyone Possibly Want To Do This?</h1>
<p>This sounds like a simple question, doesn’t it? And indeed I believe It’s simple question. However I struggle to find a simple answer. Let me at least try to explain what drove me to all of this in bit more complicated way.</p>
<p>Generally I think there are some people who focus on creating things. I’m not really one of them - sorry. Maybe I had been driven by passion for creating things in past and maybe it was reason I’ve started doing things I do. Unfortunately I feel like I enjoy learning how things work rather then simply applying that knowledge. I also think it’s absolutely fine feel differently about this.</p>
<p>Some might point out that tools are just disruption<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> from real problems and in some sense I get it. On the other hand there are folks saying that it’s almost required to learn how to use one of truly extensible editors (Vim/Emacs) to become real hacker<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>. I don’t want to do any of these points.</p>
<p>If you’re really focused on things you’re creating and don’t see any point in changing your tools it’s just fine. Just forget about this article right now and go do stuff you’re really interested in.</p>
<p>As you can imagine I spent quite a some time learning and putting together <a href="https://github.com/turboMaCk/Dotfiles/blob/master/vimrc">my original Vim configuration</a>. Why I did start over and switch to Emacs then? I think this is actually more philosophical than practical question. Both Vim and Emacs has own way of thinking about world. To some degree Vim is more *NIXy kind of tool. It does one thing and it does it well - text manipulation. Yes learning curve isn’t the smoothest one but once you get to used to it it’s fairly simple. It’s also extensible even though you’re forced to use VimL<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> which is a bit strange language. However it’s still pretty straight forward tool. It’s also limited by design and its simplicity to some degree. Vim itself is synchronous (even blocking UI) and it doesn’t really supports much that goes beyond basic text editing. Even though there are projects like <a href="https://github.com/neovim/neovim">Neo Vim</a> I think it’ still fair to say that vim is design as ultimate tool for text manipulating and that’s it. Is it extensible? Sure but only to the point you’re not trying to bend it way too much. Than it starts to feel.. strange.</p>
<p>Emacs on the other hand is Lips interpreter with interface for text editing. It’s extensibility is insane. As old joke you probably heard says: “Emacs is a great operating system lacking only decent text editor.” Think about it this way. Emacs is framework given to you so you can build your own editor or anything you want in it. It’s much more complicated than Vim is. For good and bad there are more concepts you need to learn to actually understand even small fraction of what Emacs can do. Anyway for text editing addicts this is an ultimate tool. If you like text as I do you have all reasons to consider using Emacs.</p>
<h1 id="frustration">Frustration</h1>
<p>I have to admit I’m not one of these super smart people. Anyway I think I have good resistance to a pain. I’m usually able to force myself through the hard path and somehow handle it without going crazy too much. Or maybe I have no problem with going crazy a bit. Anyway I have to admit that this was hard. I was playing with Emacs for some time before I actually started using it as main editor. I’ve tried <a href="https://github.com/syl20bnr/spacemacs">Spacemacs</a> distribution and wasn’t really happy with it. Then I’ve rewrote my configuration from scratch at least three times. I’ve also used Emacs for about two weeks and then switched back to Vim for next few weeks simply because it drove me mad.</p>
<p>One of the worst moments is when you really need to focus on solving some problem or delivering some shit and your editor keeps telling you that you don’t really know how edit files. That sux pretty much.</p>
<p>I’ve managed to break it the hard way. I can tell you that I don’t want to ever go through this process again. The truth is I don’t know if it was worth it. I know I’m happy now but I’m pretty sure I’m not objective at this point. Anyway I have some advise especially for people who are coming to Emacs from Vim. Few lessons I’ve learned anyone should know up front.</p>
<h2 id="learn-first">Learn First</h2>
<p>You don’t have to switch from day to day. Generally it’s good idea to play with Emacs a bit first. And I mean pure Emacs.</p>
<h2 id="e-lisp-is-your-friend">E-Lisp is Your Friend</h2>
<p>If you’re starting I think it’s better to play with emacs-lisp rather than use it for working on your projects. Using Emacs to do some work without knowing it will be only frustrating experience. Using it to learn emacs-lisp helps you to stay focus and enjoy that experience. Also elisp has amazing support up front. Let it be the measure for how you want to build your workflow for other languages.</p>
<h2 id="dont-be-too-much-evil">Don’t be Too Much Evil</h2>
<p>Evil mode is great. Anyway looking back I think it is really not a good idea to rely on it much especially at the beginning. Evil is really Vim for Emacs but Emacs + Evil is much more than Vim inside Emacs. Don’t ignore it. You will have to learn some of the Emacs way sooner and later. Sooner is better.</p>
<h2 id="try-to-use-emacs-in-yours-workflow">Try To Use Emacs In YOURS Workflow</h2>
<p>There are many cool plugins you want to try out I know. Anyway You can’t possibly change your whole workflow in one day. If you’re using tmux try to use Emacs within tmux<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a>. If you’re coming from GUI editor - use GUI and forget about terminal version.</p>
<h2 id="dont-stick-with-it-for-too-long-though">Don’t Stick With It For Too Long Though…</h2>
<p>Once you feel comfortable with Emacs try to evolve your workflow.</p>
<h3 id="gui-version-is-better">GUI Version Is Better</h3>
<p>Really it is. Are you running Emacs with in terminal? What about running terminal within Emacs?</p>
<h3 id="magit-is-awesome">Magit is Awesome</h3>
<p>I heard you like command line tools. That’s great. I like them too. Give Magit a try anyway. It’s advanced and you can switch to terminal any time you want.</p>
<h3 id="org-mode-is-super-cool-but-not-necessary">Org Mode is Super Cool… But NOT Necessary</h3>
<p>Org mode is great. You want to learn it. However if you’re programmer I think it’s not the most important thing. You should focus on work first. Org mode is really simple and you can learn it in no time later.</p>
<h1 id="after-one-year">After One Year</h1>
<p>So I’m kind of celebrating my first year with Emacs. I really wanted to make some recap of what I’ve learned. So I’ve <a href="https://github.com/turboMaCk/Dotemacs">rewrote my configuration to org-mode as literate program</a>. I’ve also switched from <code>use-package</code> to <a href="https://github.com/cask/cask">Cask</a> and <a href="https://github.com/rdallasgray/pallet">Pallet</a>. Once again I’ve spend some of my free time just for setting things up. This is what we OCD’s do, right?</p>
<p>I also made few other changes / decisions based on my personal preferences:</p>
<h2 id="no-more-evil-leader">No More evil-leader</h2>
<p>For some reason I don’t feel like I’ll need to use evil-leader anymore. I don’t think it fits well to Emacs. It was really helpful for making Emacs feel more like Vim at first but now I feel like I want to use Emacs way of bindings rather then using leader.</p>
<h2 id="goodbye-neotree">Goodbye NeoTree</h2>
<p>You might know NERDTree plugin for Vim. It’s largely popular among Vimmers. However I was never really happy with Neotree (Emacs alternative) for many reasons I don’t want to discuss here. To prevent this frustration I simply forced myself not to use it by removing it. I’ll rather use basics like <code>dired</code> or <code>C-x C-f</code> instead going forward.</p>
<h1 id="are-emacs-users-better-programmers">Are Emacs Users Better Programmers?</h1>
<p>Hard to say. But you bet I believe they are as every other Emacs user do:D Probably it’s better to avoid any discussion like this right from start. In any case I think that there are certain skill which comes from experience of setting up Emacs. In the end your configuration is probably <strong>the biggest project of your life time</strong>. It will live and evolve with you. It’s worth understanding and spending some time on its maintainance. But in the end it’s all up to you.</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>You can find many articles about tools as procrastination and similar.</p>
<ul>
<li>MPJ’s video about why he uses basic text editor without extra config: <a href="https://www.youtube.com/watch?v=dIjKJjzRX_E" class="uri">https://www.youtube.com/watch?v=dIjKJjzRX_E</a></li>
<li>J. Pabblo Fernández - Emacs is hurting clojure <a href="https://pupeno.com/2016/09/26/emacs-is-hurting-clojure/" class="uri">https://pupeno.com/2016/09/26/emacs-is-hurting-clojure/</a></li>
</ul>
<a href="#fnref1">↩</a></li>
<li id="fn2"><p>Again there are dozens of examples about this topic.</p>
<ul>
<li>Perry Metzger - The Editor of The Lifetime talk <a href="https://www.youtube.com/watch?v=VADudzQGvU8" class="uri">https://www.youtube.com/watch?v=VADudzQGvU8</a></li>
</ul>
<a href="#fnref2">↩</a></li>
<li id="fn3"><p>Actually Vim also supports plugins written in Python and other languages but these simply don’t feel like first class citizens.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Check navigate.el for integration with Tmux. <a href="https://github.com/keith/evil-tmux-navigator" class="uri">https://github.com/keith/evil-tmux-navigator</a><a href="#fnref4">↩</a></p></li>
</ol>
</div>]]></description>
    <pubDate>Thu, 29 Dec 2016 00:00:00 UT</pubDate>
    <guid>http://turbomack.github.iuo/posts/2016-12-29-from-vim-to-emacs-year-later.html</guid>
    <dc:creator>Marek Fajkus</dc:creator>
</item>
<item>
    <title>Org Mode in Hakyll</title>
    <link>http://turbomack.github.iuo/posts/2016-12-21-org-mode-in-hakyll.html</link>
    <description><![CDATA[<p>As an <a href="https://gnu.org/software/emacs/">Emacs</a> user I’m really glad that I can benefit from full power of <a href="http://pandoc.org">Pandoc</a> thanks to <a href="https://jaspervdj.be/hakyll/">Hakyll</a> while creating this site. One of the Emacs’ beloved mode - <a href="http://orgmode.org/">org-mode</a> is supported by Pandoc therefore you can use it as markup language in Hakyll. Org-mode is really powerful. There is only problem with it - it’s almost exclusive for Emacs environment. <a href="https://gist.github.com/kinjo/509761">Github</a> maybe supports org preview but true power of org comes from editing experience in Emacs. Because Org is so exclusive to Emacs (written in E-Lisp) it’s hardly default markup even for many Emacs users simply because many of them has to to support all kinds of users not just ones who happen to use Emacs and org. Markdown is de-facto standard these days. This is for example why I’m personally also writing markdown daily. However this is quite different when it comes to project maintained only by one person - you. Org mode is simply so much better for taking notes, creating to-dos and much more that it become one of the most successful Emacs extension. Especially when it comes to <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a> which is what I mostly trying to do on this blog and more generally <a href="http://reproducibleresearch.net">reproducible research</a> which is movement I’m pretty big fan of. I’m also actively looking for interesting ideas and tools since I’ve discovered <a href="https://jupyter.org">Jubyter notebooks</a> about a year ago.</p>
<p>To be honest since I’m mostly working on documents maintain by group of people (mostly colleagues) I’m not really an expert on org-mode. Anyway I was working on new blog post recently where I would really appreciate some of Org’s features. This is why I’ve recently added org support to this site willing to test Pandoc support. I’ve also decided to keep this document public on this site as a kind of reference which might be helpful to some folks.</p>
<p>Actually this is the end of post itself. Everything below is just to test how Pandoc handles org files.</p>
<h1 id="this-is-h1">This is H1</h1>
<p>There is paragraph under h1</p>
<h2 id="h2">H2</h2>
<h3 id="h3">H3</h3>
<h1 id="some-basic-test">Some basic test</h1>
<p>This is <strong>bold</strong>, <em>italic</em>, <code>code</code>, <code>verbatim</code> and <del>strike</del> text.</p>
<ul>
<li>However <strong><em>bold and italic</em></strong> doesn’t play well when used together like in markdown.</li>
<li>However <em><strong>bold and italic</strong></em> doesn’t play well when used together like in markdown.</li>
</ul>
<h1 id="list">List</h1>
<ul>
<li>Bullet</li>
<li>Another bullet
<ul>
<li>child
<ul>
<li>deep</li>
</ul></li>
</ul></li>
</ul>
<h2 id="other-style">Other style</h2>
<ul>
<li>Bullet</li>
<li>Another bullet * child * deep</li>
</ul>
<h2 id="other-style-1">Other style</h2>
<ol>
<li>Bullet</li>
<li>Another bullet
<ol>
<li>child
<ol>
<li>deep</li>
</ol></li>
</ol></li>
</ol>
<p>Style <code>*</code> isn’t supported.</p>
<h1 id="links">Links</h1>
<p><em><a href="http://orgmode.org/" class="uri">http://orgmode.org/</a></em></p>
<h1 id="check-list-13-33">Check List [1/3] [33%]</h1>
<ul>
<li>[ ] Item</li>
<li>[ ] Item</li>
<li>[X] Checked item</li>
</ul>
<p>Heading and has special class however <code>&lt;ul&gt;</code> and <code>&lt;li&gt;</code> are plain.</p>
<h1 id="task-list">Task List</h1>
<h2 id="some-to-do"><span class="todo TODO">TODO</span> some to-do</h2>
<h2 id="done-to-do"><span class="done DONE">DONE</span> done to-do</h2>
<p>Items are added with special class.</p>
<h1 id="tables">Tables</h1>
<table>
<thead>
<tr class="header">
<th>number</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>looooong long name</td>
</tr>
<tr class="even">
<td>5</td>
<td>name</td>
</tr>
</tbody>
</table>
<p><code>&lt;tr&gt;</code> has <code>even</code> and <code>odd</code> classes.</p>
<h1 id="source-code">Source Code</h1>
<p><strong>Emacs Lisp:</strong></p>
<div class="sourceCode"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp">(<span class="kw">defun</span><span class="fu"> negate </span>(x)
    <span class="st">&quot;Negate the value of x.&quot;</span>
    (<span class="op">-</span> x))</code></pre></div>
<div class="sourceCode" rundoc-language="emacs-lisp" rundoc-results="output"><pre class="sourceCode commonlisp rundoc-block"><code class="sourceCode commonlisp">(<span class="kw">print</span>
    (negate <span class="dv">10</span>))</code></pre></div>
<pre class="example"><code>-10
</code></pre>
<p>There are interesting classes like <code>sourceCode</code> and <code>example</code>. Also there html5 attributes prefixed with <code>rundoc-</code>.</p>
<p><strong>Haskell:</strong></p>
<div class="sourceCode" rundoc-language="haskell" rundoc-results="output"><pre class="sourceCode haskell rundoc-block"><code class="sourceCode haskell"><span class="ot">factorial ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span>
factorial <span class="dv">0</span> <span class="fu">=</span> <span class="dv">1</span>
factorial n <span class="fu">=</span> n <span class="fu">*</span> factorial (n <span class="fu">-</span> <span class="dv">1</span>)</code></pre></div>
<h1 id="latex">LaTeX</h1>
<ul>
<li><strong>Characters:</strong> <em>α</em> <em>β</em> → ↑ ∨ ∧ ⟹ <em>π</em> ∞</li>
<li><strong>Inline Math:</strong> <span class="math inline"><em>f</em>(<em>x</em>)=<em>x</em><sup>2</sup></span></li>
<li><strong>More complex:</strong> <span class="math inline">$\frac{x^2}{2}$</span></li>
</ul>
<p>LaTeX characters are wrapped in <code>&lt;em&gt;</code> and Math inside <code>&lt;span class=&quot;math inline&quot;&gt;</code>.</p>
<h2 id="ℋℯ𝓁𝓁ℴ">ℋℯ𝓁𝓁ℴ!</h2>

<p><strong>NOTE:</strong> <em>There is standard LaTeX embeded above which is skipped during compilation to HTML.</em></p>
<p><strong>This is using</strong> <em><a href="https://www.mathjax.org/" class="uri">https://www.mathjax.org/</a></em></p>
<p><br /><span class="math display">$$\sum_{i=0}^n i^2 = \frac{(n^2+n)(2n+1)}{6}$$</span><br /></p>
<h1 id="deadline">Deadline</h1>
<p>DEADLINE: &lt;2016-12-20 Tue&gt;</p>
<h1 id="tagged">Tagged<span class="tag" data-tag-name="tag"></span></h1>
<p>Tags are not visible in render</p>
<h1 id="block-quote">Block Quote</h1>
<blockquote>
<p>Org mode is amazing. So is Hakyll &amp; Pandoc.</p>
</blockquote>
<h1 id="image">Image</h1>
<p><a href="http://media.riffsy.com/images/f8534774b678ad1932b379a03460680b/raw" class="uri">http://media.riffsy.com/images/f8534774b678ad1932b379a03460680b/raw</a></p>
<p>Images has to have extension like:</p>
<p><img src="../assets/reddit.png" /></p>
<p>then it can be loaded even from other origin..</p>
<p><img src="http://45.media.tumblr.com/270992d792c9899f79888a8ea6955ca5/tumblr_o0jt792qLd1r83d7lo6_540.gif" /></p>
<h1 id="description-list">Description List</h1>
<dl>
<dt>Frodo</dt>
<dd>The hobbit ringbearer
</dd>
<dt>Aragorn</dt>
<dd>The human ranger, true kind of Gondor
</dd>
<dt>Gandalf</dt>
<dd>The Grey Wizard
</dd>
</dl>
<p>creddits to <em><a href="https://www.reddit.com/user/nihilmancer" class="uri">https://www.reddit.com/user/nihilmancer</a></em></p>
<h1 id="footnotes">Footnotes</h1>
<p>This has some<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> foot note.</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The link is: <a href="http://orgmode.org" class="uri">http://orgmode.org</a><a href="#fnref1">↩</a></p></li>
</ol>
</div>]]></description>
    <pubDate>Wed, 21 Dec 2016 00:00:00 UT</pubDate>
    <guid>http://turbomack.github.iuo/posts/2016-12-21-org-mode-in-hakyll.html</guid>
    <dc:creator>Marek Fajkus</dc:creator>
</item>
<item>
    <title>Hybrid Types in TypeScript</title>
    <link>http://turbomack.github.iuo/posts/2016-12-07-hybrid-types-in-typescript.html</link>
    <description><![CDATA[<p>Yesterday I’ve been refactoring one of our internal library in <a href="globalwebindex.net">GWI</a> from JavaScript to TypeScript. As a JavaScript veteran I like to use some edgy non-conventional &amp; pre-ES 2015 coding styles. I’m not using <code>prototype</code>, <code>class</code> or <code>this</code> much often. I’m rather using <a href="http://javascript.info/tutorial/factory-constructor-pattern">Factory Constructor Pattern</a> quite often as well as <a href="https://en.wikipedia.org/wiki/Higher-order_function">Higher Order Functions</a> for simulating <a href="https://en.wikipedia.org/wiki/Currying">currying</a> and like to with objects and play with scopes. Now you might think that this is silly. No one will understand my code and using truly private functions makes it harder to extend functionality. And you’re right:D Anyway I know that I can write more reliable code more quickly and from my experience when code is reliable enough not many people will need to change it. And when they do they are mostly experienced and are able to understand it. Also I like private functions. If you miss any functionality or abstraction it’s always good idea to add it directly to library or write your own than hack it. Anyway this article is not about these patterns and how to use them but rather about how it feels when you put <a href="https://www.typescriptlang.org">TypeScript</a> in the mix. If you want to learn more about these patterns <a href="https://duckduckgo.com/">DuckDuckGo</a> some other article.</p>
<p>First let me explain one thing. I’m not writing TypeScript day to day. But when I do I’m mostly exploring edges of what it can do. I’m writing a lot of ES 2015 ECMAScript in work and <a href="elm-lang.org">Elm</a> for fun (what is slowly changing since we already shipped first feature written in Elm elm as part of our production <a href="ember.js">Ember.js</a> app).</p>
<h1 id="problem">Problem</h1>
<p>The idea is this. We have got our internal system for charts written in <a href="https://d3js.org/">D3.js</a>. Some parts of this are <a href="https://github.com/GlobalWebIndex/d3scription">open-sourced and available on GitHub</a>. In GWI we have got whole charts written in pure D3 that are sharing common interface so on application layer you’re basically just dynamically switching factory functions for charts based on based on chart type and everything works like a magic. However testing visualization layer is hard or even impossible. Wouldn’t it be a good idea to have at least type check for these interfaces? I think it would!</p>
<p>For purpose of this tutorial I’ve picked one smaller part rather than whole chart. D3 itself comes with component called <a href="https://github.com/d3/d3/blob/master/API.md#axes-d3-axis">d3.svg.axis</a>. However sometimes it doesn’t fit your needs so you’ll need to implement your own solution. Lets say we want to implement custom axis which will create ticks based on data we have so for each data-point it will create a tick on axis. This is how we want to use our new component:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">const</span> axis <span class="op">=</span> <span class="at">exactAxis</span>()
    .<span class="at">scale</span>(scale)
    .<span class="at">data</span>(someData)
    .<span class="at">tickFormat</span>(d <span class="op">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>

<span class="va">d3</span>.<span class="at">select</span>(<span class="st">&#39;.axis-group&#39;</span>).<span class="at">call</span>(axis)<span class="op">;</span></code></pre></div>
<p>As you can see I’ve chosen <code>exactAxis</code> as a name for this component. It’s a <code>function</code>. However it returns some <code>Object</code> that has at least <code>scale</code>, <code>data</code> &amp; <code>tickFormat</code> methods. We’re using chaining so at least <code>scale</code> and <code>data</code> should return object they are defined on. Also on the last line we are using <a href="https://github.com/d3/d3-selection/blob/master/README.md#selection_call">d3.selection.call</a> which means that <code>axis</code> (thing returned by <code>tickFormat</code> call) needs to be <code>function</code>. This might mean that <code>tickFormat</code> returns some <code>function</code> instead of <code>object</code> but that is silly idea. Then you will need to always call <code>tickFormat</code> as last method. That said I think we can agree that:</p>
<ul>
<li><code>exactAxis()</code> returns <code>function</code> (and <strong>functions are Objects in JavaScript</strong>) with all methods defined.</li>
<li>Each method will return object it’s called on (so we can chain method calls).</li>
</ul>
<h1 id="interface">Interface</h1>
<p>Now we know what we need so lets define interface for out <code>exactAxis</code> function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> d3 <span class="im">from</span> <span class="st">&#39;d3&#39;</span><span class="op">;</span>

<span class="kw">interface</span> TickFormat <span class="kw">extends</span> Function <span class="op">{</span>
    (any) <span class="op">:</span> string<span class="op">;</span>
<span class="op">}</span>

<span class="kw">interface</span> ExactAxis <span class="kw">extends</span> Function <span class="op">{</span>
    (<span class="dt">g </span><span class="op">:</span> <span class="va">d3</span>.<span class="at">Selection</span><span class="op">&lt;</span>any<span class="op">&gt;</span>) <span class="op">:</span> <span class="kw">void</span><span class="op">;</span>
    <span class="at">scale</span>(<span class="dt">scale </span><span class="op">:</span> <span class="va">d3</span>.<span class="va">scale</span>.<span class="at">Ordinal</span><span class="op">&lt;</span>any<span class="op">,</span> any<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">;</span>
    <span class="at">data</span>(<span class="dt">data </span><span class="op">:</span> any[]) <span class="op">:</span> ExactAxis<span class="op">;</span>
    <span class="at">tickFormat</span>(<span class="dt">fc </span><span class="op">:</span> TickFormat) <span class="op">:</span> ExactAxis<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>As you can see there are some <code>any</code> used. Maybe it’s good idea to solve this using <a href="https://www.typescriptlang.org/docs/handbook/generics.html">Generics</a>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> d3 <span class="im">from</span> <span class="st">&#39;d3&#39;</span><span class="op">;</span>

<span class="kw">interface</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="kw">extends</span> Function <span class="op">{</span>
    (<span class="dt">data </span><span class="op">:</span> T) <span class="op">:</span> string<span class="op">;</span>
<span class="op">}</span>

<span class="kw">interface</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="kw">extends</span> Function <span class="op">{</span>
    (<span class="dt">g </span><span class="op">:</span> <span class="va">d3</span>.<span class="at">Selection</span><span class="op">&lt;</span>any<span class="op">&gt;</span>) <span class="op">:</span> <span class="kw">void</span><span class="op">;</span>
    <span class="at">scale</span>(<span class="dt">scale </span><span class="op">:</span> <span class="va">d3</span>.<span class="va">scale</span>.<span class="at">Ordinal</span><span class="op">&lt;</span>any<span class="op">,</span> any<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;;</span>
    <span class="at">data</span>(<span class="dt">data </span><span class="op">:</span> T[]) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;;</span>
    <span class="at">tickFormat</span>(<span class="dt">fc </span><span class="op">:</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;;</span>
<span class="op">}</span></code></pre></div>
<p>OK this is better. Now it’s obvious that we are passing some data around.</p>
<p>There are still some <code>any</code> used for d3 parts but I think we can leave it.</p>
<h1 id="so-called-hybrid-types-in-ts">So Called Hybrid Types in TS</h1>
<p>Now we can actually start implementing our axis component. This was the part I was not familiar till yesterday. I was actually asking some friends who work with typescript daily how an interface like this can be implemented in typescript but unluckily no one knew. I knew how this can be done in JS but that implementation did not satisfy tsc (compiler). Than as all SW engineers I’ve turned my last hope to <a href="https://www.typescriptlang.org/docs/handbook/interfaces.html">documentation</a> and found part about <a href="https://www.typescriptlang.org/docs/handbook/interfaces.html#hybrid-types">Hybrid Types</a>.</p>
<blockquote>
<p>As we mentioned earlier, interfaces can describe the rich types present in real world JavaScript. Because of JavaScript’s dynamic and flexible nature, you may occasionally encounter an object that works as a combination of some of the types described above.</p>
</blockquote>
<p>That’s exactly what I was looking for!</p>
<p>Let’s have a look at how we minimal “implementation” that satisfy our interface:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> exactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span>() <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> axis <span class="op">=</span> <span class="op">&lt;</span>ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span><span class="kw">function</span>() <span class="op">{</span>
    <span class="op">}</span>

    <span class="va">axis</span>.<span class="at">scale</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">scale </span><span class="op">:</span> <span class="va">d3</span>.<span class="va">scale</span>.<span class="at">Ordinal</span><span class="op">&lt;</span>any<span class="op">,</span> any<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        <span class="cf">return</span> axis<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">axis</span>.<span class="at">data</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">d </span><span class="op">:</span> T[]) <span class="op">{</span>
        <span class="cf">return</span> axis<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">axis</span>.<span class="at">tickFormat</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">fc </span><span class="op">:</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        <span class="cf">return</span> axis<span class="op">;</span>
    <span class="op">}</span>

    <span class="cf">return</span> axis<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>That’s it! Actually this won’t do anything but it’s whole boiler plate we need. Now comes the easy part. We can just simply implement logic (and that’s always simpler than designing API, right?)</p>
<p>So as a bonus - This is one possible full implementation:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> exactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span>() <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
    <span class="co">// Constants</span>
    <span class="kw">const</span> <span class="dt">TEXT_DELTA </span><span class="op">:</span> number <span class="op">=</span> <span class="dv">25</span><span class="op">;</span>
    <span class="kw">const</span> <span class="dt">WITHOUT_TEXT_DELTA </span><span class="op">:</span> number <span class="op">=</span> <span class="fl">12.5</span><span class="op">;</span>

    <span class="co">// Instance variables</span>
    <span class="kw">let</span> <span class="dt">data </span><span class="op">:</span> T[] <span class="op">=</span> []<span class="op">;</span>
    <span class="kw">let</span> <span class="dt">tickFormat </span><span class="op">:</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> (d) <span class="op">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="sc">}</span><span class="vs">`</span><span class="op">;</span>
    <span class="kw">let</span> scale<span class="op">;</span>

    <span class="co">// Render</span>

    <span class="kw">const</span> axis <span class="op">=</span> <span class="op">&lt;</span>ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span><span class="kw">function</span>(g) <span class="op">{</span>

        <span class="co">// D3 always returns array</span>
        <span class="co">// Lets render axis for every given group.</span>
        <span class="va">g</span>.<span class="at">each</span>(<span class="kw">function</span>() <span class="op">{</span>
            <span class="kw">const</span> <span class="dt">$el </span><span class="op">:</span> <span class="va">d3</span>.<span class="at">Selection</span><span class="op">&lt;</span>any<span class="op">&gt;</span> <span class="op">=</span> <span class="va">d3</span>.<span class="at">select</span>(<span class="kw">this</span>)<span class="op">;</span>

            <span class="co">// Prepare data for ticks</span>
            <span class="kw">const</span> ticksData <span class="op">=</span> <span class="va">data</span>.<span class="at">sort</span>((a<span class="op">,</span> b) <span class="op">=&gt;</span> <span class="at">Number</span>(a) <span class="op">-</span> <span class="at">Number</span>(b))
                .<span class="at">reduce</span>((acc<span class="op">,</span> d) <span class="op">=&gt;</span> <span class="op">{</span>
                    <span class="kw">const</span> latestWithText <span class="op">=</span> <span class="at">last</span>(<span class="va">acc</span>.<span class="at">withText</span>)<span class="op">;</span>

                    <span class="co">// skip duplicates immediately</span>
                    <span class="cf">if</span> (latestWithText <span class="op">&amp;&amp;</span> latestWithText <span class="op">===</span> d) <span class="op">{</span> <span class="cf">return</span> acc<span class="op">;</span> <span class="op">}</span>

                    <span class="co">// for first or not too close we add text one</span>
                    <span class="cf">if</span> (<span class="op">!</span>latestWithText <span class="op">||</span> <span class="va">Math</span>.<span class="at">abs</span>(<span class="at">scale</span>(latestWithText) <span class="op">-</span> <span class="at">scale</span>(d)) <span class="op">&gt;=</span> TEXT_DELTA) <span class="op">{</span>
                        <span class="va">acc</span>.<span class="va">withText</span>.<span class="at">push</span>(d)<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        <span class="co">// we add tick without text</span>
                        <span class="kw">const</span> latestWithoutText <span class="op">=</span> <span class="at">last</span>(<span class="va">acc</span>.<span class="at">withoutText</span>)<span class="op">;</span>

                        <span class="co">// check for delta from latest with text</span>
                        <span class="cf">if</span> (<span class="va">Math</span>.<span class="at">abs</span>(<span class="at">scale</span>(latestWithText) <span class="op">-</span> <span class="at">scale</span>(d)) <span class="op">&gt;=</span> WITHOUT_TEXT_DELTA) <span class="op">{</span>

                            <span class="co">// check for delta from latest without text</span>
                            <span class="cf">if</span> (<span class="op">!</span>latestWithoutText <span class="op">||</span> <span class="va">Math</span>.<span class="at">abs</span>(<span class="at">scale</span>(latestWithoutText) <span class="op">-</span> <span class="at">scale</span>(d)) <span class="op">&gt;=</span> WITHOUT_TEXT_DELTA) <span class="op">{</span>
                                <span class="va">acc</span>.<span class="va">withoutText</span>.<span class="at">push</span>(d)<span class="op">;</span>
                            <span class="op">}</span>
                        <span class="op">}</span>
                    <span class="op">}</span>

                    <span class="cf">return</span> acc<span class="op">;</span>
                <span class="op">},</span> <span class="op">{</span> <span class="dt">withText</span><span class="op">:</span> []<span class="op">,</span> <span class="dt">withoutText</span><span class="op">:</span> [] <span class="op">}</span> )<span class="op">;</span>

            <span class="co">// Render</span>

            <span class="co">// With text</span>
            <span class="kw">const</span> withText <span class="op">=</span> <span class="va">g</span>.<span class="at">selectAll</span>(<span class="st">&#39;.tick.tick--with-text&#39;</span>).<span class="at">data</span>(<span class="va">ticksData</span>.<span class="at">withText</span>)<span class="op">;</span>

            <span class="va">withText</span>.<span class="at">enter</span>().<span class="at">append</span>(<span class="st">&#39;g&#39;</span>)
                .<span class="at">attr</span>(<span class="st">&#39;class&#39;</span><span class="op">,</span> <span class="st">&#39;tick tick--with-text&#39;</span>)
                .<span class="at">append</span>(<span class="st">&#39;text&#39;</span>)
                .<span class="at">style</span>(<span class="st">&#39;text-anchor&#39;</span><span class="op">,</span> <span class="st">&#39;middle&#39;</span>)<span class="op">;</span>

            <span class="va">withText</span>.<span class="at">transition</span>()
                .<span class="at">attr</span>(<span class="st">&#39;transform&#39;</span><span class="op">,</span> d <span class="op">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="at">scale</span>(d)<span class="sc">}</span><span class="vs">, 15)`</span>)
                .<span class="at">select</span>(<span class="st">&#39;text&#39;</span>)
                .<span class="at">text</span>(tickFormat)<span class="op">;</span>

            <span class="va">withText</span>.<span class="at">exit</span>().<span class="at">remove</span>()<span class="op">;</span>

            <span class="co">// Without text</span>
            <span class="kw">const</span> withoutText <span class="op">=</span> <span class="va">g</span>.<span class="at">selectAll</span>(<span class="st">&#39;.tick.tick--without-text&#39;</span>).<span class="at">data</span>(<span class="va">ticksData</span>.<span class="at">withoutText</span>)<span class="op">;</span>

            <span class="va">withoutText</span>.<span class="at">enter</span>().<span class="at">append</span>(<span class="st">&#39;g&#39;</span>)
                .<span class="at">attr</span>(<span class="st">&#39;class&#39;</span><span class="op">,</span> <span class="st">&#39;tick tick--without-text&#39;</span>)
                .<span class="at">append</span>(<span class="st">&#39;line&#39;</span>)
                .<span class="at">attr</span>(<span class="st">&#39;x1&#39;</span><span class="op">,</span> <span class="dv">0</span>)
                .<span class="at">attr</span>(<span class="st">&#39;x2&#39;</span><span class="op">,</span> <span class="dv">0</span>)
                .<span class="at">attr</span>(<span class="st">&#39;y1&#39;</span><span class="op">,</span> <span class="dv">0</span>)
                .<span class="at">attr</span>(<span class="st">&#39;y2&#39;</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span>

            <span class="va">withoutText</span>.<span class="at">transition</span>()
                .<span class="at">attr</span>(<span class="st">&#39;transform&#39;</span><span class="op">,</span> d <span class="op">=&gt;</span> <span class="vs">`trnaslate(</span><span class="sc">${</span><span class="at">scale</span>(d)<span class="sc">}</span><span class="vs">, 0)`</span>)<span class="op">;</span>

            <span class="va">withoutText</span>.<span class="at">exit</span>().<span class="at">remove</span>()<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Public Interface</span>

    <span class="va">axis</span>.<span class="at">scale</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">newScale </span><span class="op">:</span> <span class="va">d3</span>.<span class="va">scale</span>.<span class="at">Ordinal</span><span class="op">&lt;</span>any<span class="op">,</span> any<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        scale <span class="op">=</span> newScale<span class="op">;</span>
        <span class="cf">return</span> axis<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">axis</span>.<span class="at">data</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">d </span><span class="op">:</span> T[]) <span class="op">{</span>
        data <span class="op">=</span> d<span class="op">;</span>
        <span class="cf">return</span> axis<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">axis</span>.<span class="at">tickFormat</span> <span class="op">=</span> <span class="kw">function</span>(<span class="dt">fc </span><span class="op">:</span> TickFormat<span class="op">&lt;</span>T<span class="op">&gt;</span>) <span class="op">:</span> ExactAxis<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span>
        tickFormat <span class="op">=</span> fc<span class="op">;</span>
        <span class="cf">return</span> axis<span class="op">;</span>
    <span class="op">}</span>

    <span class="cf">return</span> axis<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p><em>Note: If you read carefully you know that I’m not using <code>this</code> often. However for this example has one usage of <code>this</code> to get element in d3’s <code>each</code> method. It doesn’t make sense to go against library API.</em></p>
<p><em>Note: This is really simplified implementation. Actual thing similar to this we have in our lib uses 3 types of ticks (long text, short text, no text). This means also different interface for <code>FormatValue</code> an we are also always adding line tick (without text) in middle of ticks with text. However I think this simpler example is better for purpose of this article.</em></p>
<h1 id="dont-drink-too-much-kool-aid">Don’t Drink Too Much Kool-Aid</h1>
<p>TypeScript maybe lets you express these kind of dynamic APIs but there is down side to it. If you remove implementation for any method compiler won’t complain even though your function does not return valid <code>ExactAxis&lt;T&gt;</code> implementation. However if you make mistake in method implementation (change its types) it will fail during compile time which seems as an improvement to pure JS version. That said if you want to play with something like this It’s usually good idea to <strong>always start with boilerplate with all methods defined</strong>.</p>]]></description>
    <pubDate>Wed, 07 Dec 2016 00:00:00 UT</pubDate>
    <guid>http://turbomack.github.iuo/posts/2016-12-07-hybrid-types-in-typescript.html</guid>
    <dc:creator>Marek Fajkus</dc:creator>
</item>
<item>
    <title>Elm 0.17 - Successful Upgrade of Real World App</title>
    <link>http://turbomack.github.iuo/posts/2016-05-15-eml-0.17-upgrade.html</link>
    <description><![CDATA[<p><em>Note: This is mirror of my <a href="https://medium.com/@turbo_MaCk/elm-0-17-successful-upgrade-of-real-world-app-and-some-soft-of-guide-to-all-of-this-cafd59dec56f">original</a> article published on medium.</em></p>
<p>It has been few month since I’ve started learning <a href="http://elm-lang.org/">Elm programming language</a>. I’ve been walking around elm for quite a while without ever touching it. However not so long ago I’ve decided to learn some statically typed functional language started reading <a href="http://learnyouahaskell.com/">Learn You Haskell for Great Good!</a> and so I also finally put my hands on Elm. I’ve learned bit of syntax, core library, types, Signals, Effects, Mailboxes and <a href="https://github.com/evancz/elm-architecture-tutorial">Elm architecture</a>. It was quite interesting journey. Soon I’ll become wonder if I’ll be able to write some smaller project from end to start just using elm. Some kind of real world application to challenge myself and also this world of typed purity. I wanted it to talk to some JSON API and use Html. Github’s API seems to be good think to start with so I start writing github repository browser in elm. <a href="http://turbomack.github.io/elm-github-repos/">This is demo of app I’m talking about</a>.</p>
<p>Just few days ago to me unexpected thing happens. <a href="http://elm-lang.org/blog/farewell-to-frp">Elm 0.17 release was announced!</a> I remember myslef reading that announcement and thinking “Omg, what’s going on?!”. From that moment Signals, Messages, Effects and Mailboxes are past of Elm. What should I think of it?</p>
<blockquote class="twitter-tweet" data-lang="en">
<p lang="en" dir="ltr">
<a href="https://twitter.com/rabbitonweb"><span class="citation">@rabbitonweb</span></a> I'm not sure yet. It's interesting and scary at the same time.
</p>
— Marek Fajkus (<span class="citation">@turbo_MaCk</span>) <a href="https://twitter.com/turbo_MaCk/status/730355729778020352">May 11, 2016</a>
</blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>This was really huge change in how everybody (including me) thinks about building web apps in Elm. We all know these kind of changes are really hard to bring in practice since you already have large codebase around your ecosystem. In that moment that app I wrote few month ago came to my mind. It looks like all <a href="http://package.elm-lang.org/">packages</a> it needs are ready for 0.17. Plan was made and yesterday I finally found some time and started with upgrade to 0.17.</p>
<p>Upgrading is always painful. It really is. I’m working on pretty large Ember.js application at my company. Ember core team is pretty careful about their <a href="http://emberjs.com/deprecations/v1.x/">deprecation planing</a>. Anyway upgrading that app was (and is) a huge pain. It’s always complicated when you have tens of thousands of code lines and large test suits already written for legacy API.</p>
<p>Such a big design change that Elm 0.17 brings to its ecosystem is something that can easily kill any JavaScript framework. Remember Angular 1.x vs 2.x? Express.js vs Koa.js?</p>
<p>Luckily I have pretty small app which seems to be good candidate for going through this big upgrade process. I was not afraid of starting with upgrade since I was able to write whole app in just one day or so. Even if it turns out to be complete rewrite it can still be done over weekend.</p>
<p>One thing is particularly hard when starting with any upgrade which is to find some pattern and split work into few smaller iterations where each has its own goal. Mostly you can’t rewrite whole app at once. This is no how you design it and it shouldn’t be the way how you refactor it as well.</p>
<p>To be honest I was quite chaotic when I started with this upgrad but soon I realised some (or way how you can split upgrade into smaller iterations if you want) and this is why I’m sharing this story with you. No matter how big your project is I think you can apply these steps in order to make whole upgrade process of your elm 0.16 to 0.17 sooth and fun.</p>
<p><strong>Note: This article is just about upgrading web app based on elm-html. I also have one project written with canvas backend (it’s kind of game) and other one as a library backed up just by elm-test. Anyway I will not focus on nether of these projects.</strong></p>
<h1 id="lets-get-started">Lets get started</h1>
<p>You can check or clone whole 0.16 version code from <a href="https://github.com/turboMaCk/elm-github-repos/tree/v0.16">Github under v0.16 tag</a>. With our legacy code and <a href="https://github.com/elm-lang/elm-platform/blob/master/upgrade-docs/0.17.md">Upgrading to 0.17 guide</a> opened we are ready to try what new Elm is about.</p>
<h1 id="new-dependencies">New dependencies</h1>
<p>This is pretty straight forward. We can almost copy/paste this part from upgrade guide so Lets open elm-package.json in your favorite <a href="https://www.gnu.org/software/emacs/">Emacs</a> and get it done.</p>
<p><strong>Old version:</strong></p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;summary&quot;</span><span class="fu">:</span> <span class="st">&quot;helpful summary of your project, less than 80 characters&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;repository&quot;</span><span class="fu">:</span> <span class="st">&quot;https://github.com/user/project.git&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;BSD3&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;source-directories&quot;</span><span class="fu">:</span> <span class="ot">[</span>
        <span class="st">&quot;.&quot;</span>
    <span class="ot">]</span><span class="fu">,</span>
    <span class="dt">&quot;exposed-modules&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span>
    <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span>
        <span class="dt">&quot;deadfoxygrandpa/elm-test&quot;</span><span class="fu">:</span> <span class="st">&quot;3.1.0 &lt;= v &lt; 4.0.0&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;elm-lang/core&quot;</span><span class="fu">:</span> <span class="st">&quot;3.0.0 &lt;= v &lt; 4.0.0&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;evancz/elm-effects&quot;</span><span class="fu">:</span> <span class="st">&quot;2.0.1 &lt;= v &lt; 3.0.0&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;evancz/elm-html&quot;</span><span class="fu">:</span> <span class="st">&quot;4.0.2 &lt;= v &lt; 5.0.0&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;evancz/elm-http&quot;</span><span class="fu">:</span> <span class="st">&quot;3.0.0 &lt;= v &lt; 4.0.0&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;evancz/start-app&quot;</span><span class="fu">:</span> <span class="st">&quot;2.0.2 &lt;= v &lt; 3.0.0&quot;</span>
    <span class="fu">},</span>
    <span class="dt">&quot;elm-version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.16.0 &lt;= v &lt; 0.17.0&quot;</span>
<span class="fu">}</span></code></pre></div>
<p><strong>New version:</strong></p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;summary&quot;</span><span class="fu">:</span> <span class="st">&quot;helpful summary of your project, less than 80 characters&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;repository&quot;</span><span class="fu">:</span> <span class="st">&quot;https://github.com/user/project.git&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;BSD3&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;source-directories&quot;</span><span class="fu">:</span> <span class="ot">[</span>
        <span class="st">&quot;.&quot;</span>
    <span class="ot">]</span><span class="fu">,</span>
    <span class="dt">&quot;exposed-modules&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span>
    <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span>
        <span class="dt">&quot;elm-lang/core&quot;</span><span class="fu">:</span> <span class="st">&quot;4.0.0 &lt;= v &lt; 5.0.0&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;elm-lang/html&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0 &lt;= v &lt; 2.0.0&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;evancz/elm-http&quot;</span><span class="fu">:</span> <span class="st">&quot;3.0.1 &lt;= v &lt; 4.0.0&quot;</span>
    <span class="fu">},</span>
    <span class="dt">&quot;elm-version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.17.0 &lt;= v &lt; 0.18.0&quot;</span>
<span class="fu">}</span></code></pre></div>
<p><em>Note: As you can see I’m a little bit sloppy. Almost all meta is not filled out but since this was never published (and never will be) as package we just leave it as it is for now. One more thing to mention is that there is elm-test specified as dependency in legacy version but I actually never used it in this project. This is why it’s not in updated version.</em></p>
<p>Then we run package install as usual:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ex">elm-package</span> install</code></pre></div>
<h1 id="module-declaration">Module Declaration</h1>
<p>With new packages installed we can start rewriting application logic for new APIs. One smaller change is to update model declaration to new syntax. Replace:</p>
<pre><code>module Repos where</code></pre>
<p>with:</p>
<pre><code>module Repos exposing (main)</code></pre>
<p>We can also change imports to match new module structure.</p>
<p>Here is complete old version and new equivalent:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">Repos</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">List</span>
<span class="kw">import </span><span class="dt">Graphics.Element</span> exposing (..)
<span class="kw">import </span><span class="dt">Http</span>
<span class="kw">import </span><span class="dt">Json.Decode</span> <span class="kw">as</span> <span class="dt">Json</span> exposing ((:=))
<span class="kw">import </span><span class="dt">Task</span>
<span class="kw">import </span><span class="dt">Signal</span>
<span class="kw">import </span><span class="dt">Html</span> exposing (..)
<span class="kw">import </span><span class="dt">Html.Attributes</span> exposing (..)
<span class="kw">import </span><span class="dt">Html.Events</span> <span class="kw">as</span> <span class="dt">Events</span>
<span class="kw">import </span><span class="dt">Effects</span> exposing (<span class="dt">Effects</span>)
<span class="kw">import </span><span class="dt">StartApp</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">Repos</span> exposing (main)

<span class="kw">import </span><span class="dt">List</span>
<span class="kw">import </span><span class="dt">Html</span> exposing (..)
<span class="kw">import </span><span class="dt">Html.App</span>
<span class="kw">import </span><span class="dt">Html.Attributes</span> exposing (..)
<span class="kw">import </span><span class="dt">Html.Events</span> <span class="kw">as</span> <span class="dt">Events</span>
<span class="kw">import </span><span class="dt">Http</span>
<span class="kw">import </span><span class="dt">Json.Decode</span> <span class="kw">as</span> <span class="dt">Json</span> exposing ((:=))
<span class="kw">import </span><span class="dt">Task</span> exposing (..)</code></pre></div>
<p>As you can see this app needs much less modules using 0.17.</p>
<h1 id="views-startapp">Views + StartApp</h1>
<p>Next step according to upgrade guide should be replacing Action with Msg. Anyway I’d like to start with views since my first goal is to be able to render initial state of application. We will go back to update function in a minute.</p>
<p>What I did is to get rid off address passing from view, change type annotations and comment out all events. This is basically what needs to be done:</p>
<p>replace:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">view <span class="fu">:</span> <span class="dt">Signal.Address</span> <span class="dt">Action</span> <span class="ot">-&gt;</span> <span class="dt">Model</span> <span class="ot">-&gt;</span> <span class="dt">Html</span>
view address model <span class="fu">=</span></code></pre></div>
<p>with:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">view <span class="fu">:</span> <span class="dt">Model</span> <span class="ot">-&gt;</span> <span class="dt">Html</span> <span class="dt">Msg</span>
view model <span class="fu">=</span></code></pre></div>
<p>replace also all calls to “sub views”</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">div [ <span class="kw">class</span> “app<span class="fu">-</span>container” ]
    [ headerView address model ]</code></pre></div>
<p>with something like</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">div [ <span class="kw">class</span> “app<span class="fu">-</span>container” ]
    [ headerView model ]</code></pre></div>
<p>And finally comment out Events (we get back to them later):</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">div
    [ <span class="kw">class</span> “repo<span class="fu">-</span>main”
    <span class="co">-- , Events.onClick address (SelectRepo repo)</span>
    ]</code></pre></div>
<p>I also had custom Events for input and submit. In this step we can simply comment them out.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">-</span>— onInput <span class="fu">:</span> <span class="dt">Signal.Address</span> <span class="dt">Action</span> <span class="ot">-&gt;</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Action</span>) <span class="ot">-&gt;</span> <span class="dt">Attribute</span>
—<span class="fu">-</span> onInput address f <span class="fu">=</span>
    —<span class="fu">-</span> Events.on “input” Events.targetValue (\v <span class="ot">-&gt;</span> Signal.message address (f v))

—<span class="fu">-</span> oSubmit address value <span class="fu">=</span>
    —<span class="fu">-</span> Events.onWithOptions “submit”
        —<span class="fu">-</span> { stopPropagation <span class="fu">=</span> <span class="dt">True</span>, preventDefault <span class="fu">=</span> <span class="dt">True</span> }
        —<span class="fu">-</span> Json.value (\_ <span class="ot">-&gt;</span> Signal.message address (<span class="dt">FetchData</span> value))</code></pre></div>
<p>If you now try to compile app you can still see compile error. <strong>We no longer need port in 0.17!</strong> Let’s remove it then!</p>
<h2 id="fixing-glue">Fixing glue</h2>
<p>Now we can see much more reasonable errors during compilation. Mostly legacy Effects stuff, missing Msg type and StartApp. Let’s fix this one by one.</p>
<p>Firstly we can <strong>comment out all Effects stuff</strong> since our first goal is to render initial state. Also we need to get rid off all calls to these functions. For now lets replace every call in <strong>update</strong> with <strong>Cmd.none</strong> which is replacement for legacy <strong>Effects.none</strong>.</p>
<p>Also it looks like we are now in update function part so lets change <strong>Action</strong> type to new <strong>Msg</strong> and refactor arguments according to guide.</p>
<p>This is how update action looks like after these changes:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">update <span class="fu">:</span> <span class="dt">Msg</span> <span class="ot">-&gt;</span> <span class="dt">Model</span> <span class="ot">-&gt;</span> (<span class="dt">Model</span>, <span class="dt">Cmd</span> <span class="dt">Msg</span>)
update action model <span class="fu">=</span>
    <span class="kw">case</span> action <span class="kw">of</span>
        <span class="dt">NoOp</span> <span class="ot">-&gt;</span>
            ( model, Cmd.none )
    <span class="dt">FetchData</span> name <span class="ot">-&gt;</span>
        ( { model
            <span class="fu">|</span> isLoading <span class="fu">=</span> <span class="dt">True</span>
            , resultsFor <span class="fu">=</span> model<span class="fu">.</span>userName }
            , Cmd.none )
            —<span class="fu">-</span> , fetchDataAsEffects model<span class="fu">.</span>userName )
    <span class="dt">FetchDone</span> results <span class="ot">-&gt;</span>
        ( { model
            <span class="fu">|</span> repos <span class="fu">=</span> results
            , isLoading <span class="fu">=</span> <span class="dt">False</span>
            , alert <span class="fu">=</span> “” }
            , Cmd.none )</code></pre></div>
<p><em>Note: This is just simplified version, but you get the idea…</em></p>
<p>I my case I also need to change initialState since fetchData function is also called in this place. I’ll replace it with <strong>Cmd.none</strong> too.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">init <span class="fu">:</span> ( <span class="dt">Model</span>, <span class="dt">Cmd</span> <span class="dt">Msg</span> )
init <span class="fu">=</span>
    ( initialModel
    , Cmd.none )
    — , fetchDataAsEffects initialModel<span class="fu">.</span>userName )</code></pre></div>
<p>At last but not least we still did not change main function and legacy StartApp code. This can be copy/pasted from upgrade guide. Result looks like this:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">main <span class="fu">:</span> <span class="dt">Program</span> <span class="dt">Never</span>
main <span class="fu">=</span>
    Html.App.program
        { init <span class="fu">=</span> init
        , update <span class="fu">=</span> update
        , view <span class="fu">=</span> view
        , subscriptions <span class="fu">=</span> \_ <span class="ot">-&gt;</span> Sub.none }</code></pre></div>
<p><strong>App now renders without errors!</strong></p>
<p>Ok. Looks like there is a lot of going on. <a href="https://gist.github.com/turboMaCk/98d2e40231c4033deca29c148d4684cc#file-repos-elm">This is</a> how whole code looks like after these changes.</p>
<h1 id="goodbye-effects">Goodbye Effects!</h1>
<p>So app is kind of working now. They said if it compile, than it works, right? Anyway it’s not much useful since it do nothing. I think it’s good time to have a look at Effects. With Http working we will be able to fetch first data which seems to be reasonable next stage.</p>
<p>Looking at the <a href="http://package.elm-lang.org/packages/evancz/elm-http/3.0.1/">new api documentation</a> I think we will no longer need function for transforming Results to Action. I started by removing this one. Also one for creating Effects Action seems to be useless. Let’s remove this one too.</p>
<p>Let’s have a look at fetchData function. Looks like we will need to change this one a little bit. Here is old version:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">fetchData <span class="fu">:</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Task.Task</span> a (<span class="dt">Result</span> <span class="dt">Http.Error</span> (<span class="dt">List</span> <span class="dt">Repo</span>))
fetchData name <span class="fu">=</span>
    Http.get reposDecoder (getUrl name)
    <span class="fu">|&gt;</span> Task.toResult</code></pre></div>
<p>new implementation looks like:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">fetchData <span class="fu">:</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Cmd</span> <span class="dt">Msg</span>
fetchData name <span class="fu">=</span>
    <span class="kw">let</span> url <span class="fu">=</span>
        getUrl name
    <span class="kw">in</span>
        Task.perform <span class="dt">FetchFail</span> <span class="dt">FetchDone</span> (Http.get reposDecoder url)</code></pre></div>
<p>As you can see we will need to change error handling logic. In my case I just added Type <strong>FetchFail</strong> to <strong>Msg</strong> union type.** Thir also means we need to add this branch to pattern matching inside update function. Lets replace old <strong>Error</strong> with new <strong>FetchFail</strong>. We can reuse old <strong>httpErrorToString</strong> function for transforming <strong>Error</strong> to <strong>String</strong>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">Msg</span> <span class="fu">=</span> <span class="dt">NoOp</span>
    <span class="fu">|</span> <span class="dt">FetchData</span> <span class="dt">String</span>
    <span class="fu">|</span> <span class="dt">FetchDone</span> (<span class="dt">List</span> <span class="dt">Repo</span>)
    <span class="fu">|</span> <span class="dt">FetchFail</span> <span class="dt">Http.Error</span> <span class="co">-- THIS!!!!!!!!!!!</span>
    <span class="fu">|</span> <span class="dt">NameChanged</span> <span class="dt">String</span>
    <span class="fu">|</span> <span class="dt">SelectRepo</span> <span class="dt">Repo</span>
    <span class="fu">|</span> <span class="dt">ChangeSort</span> <span class="dt">SortBy</span>

update <span class="fu">:</span> <span class="dt">Msg</span> <span class="ot">-&gt;</span> <span class="dt">Model</span> <span class="ot">-&gt;</span> (<span class="dt">Model</span>, <span class="dt">Cmd</span> <span class="dt">Msg</span>)
update msg model <span class="fu">=</span>
    <span class="kw">case</span> msg <span class="kw">of</span>
        <span class="dt">NoOp</span> <span class="ot">-&gt;</span>
            ( model, Cmd.none )
        <span class="dt">FetchData</span> name <span class="ot">-&gt;</span>
            ( { model
                <span class="fu">|</span> isLoading <span class="fu">=</span> <span class="dt">True</span>
                , resultsFor <span class="fu">=</span> model<span class="fu">.</span>userName }
                , Cmd.none )
            — , fetchDataAsEffects model<span class="fu">.</span>userName )
        <span class="dt">FetchDone</span> results <span class="ot">-&gt;</span>
            ( { model
                <span class="fu">|</span> repos <span class="fu">=</span> results
                , isLoading <span class="fu">=</span> <span class="dt">False</span>
                , alert <span class="fu">=</span> “” }
                , Cmd.none )
        <span class="dt">FetchFail</span> error <span class="ot">-&gt;</span> <span class="co">-- THIS!!!!!!!!!!!!</span>
            ( { model
                <span class="fu">|</span> repos <span class="fu">=</span> []
                , isLoading <span class="fu">=</span> <span class="dt">False</span>
                , alert <span class="fu">=</span> (httpErrorToString model<span class="fu">.</span>userName error) }
                , Cmd.none )</code></pre></div>
<p>Nice! App should now compile without errors.</p>
<p>Now we can change init function and try if it works. Change:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">init <span class="fu">:</span> ( <span class="dt">Model</span>, <span class="dt">Cmd</span> <span class="dt">Msg</span> )
init <span class="fu">=</span>
    ( initialModel
    , fetchDataAsEffects initialModel<span class="fu">.</span>userName )</code></pre></div>
<p>to:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">init <span class="fu">:</span> ( <span class="dt">Model</span>, <span class="dt">Cmd</span> <span class="dt">Msg</span> )
init <span class="fu">=</span>
    ( initialModel
    , fetchData initialModel<span class="fu">.</span>userName )</code></pre></div>
<p><strong>It works! There is no compile error, request is sent and results are rendered. So far so good!</strong></p>
<p>To complete this part we can just remove <strong>Cmd.none</strong> and call <strong>fetchData</strong> in update function’s <strong>FetchData</strong> branch which will be triggered later via user interactions.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    <span class="dt">FetchData</span> name <span class="ot">-&gt;</span>
        ( { model
            <span class="fu">|</span> isLoading <span class="fu">=</span> <span class="dt">True</span>
            , resultsFor <span class="fu">=</span> model<span class="fu">.</span>userName }
            , fetchData model<span class="fu">.</span>userName )</code></pre></div>
<p><a href="https://gist.github.com/turboMaCk/a2f9b204f3259fb2be10754e4ad10565#file-repos-elm">This</a> is snapshot of code at this stage:</p>
<h1 id="events">Events</h1>
<p>We are almost finished. Last missing step is to bring back events to allow user interactions.</p>
<p>I’d like to start with uncommenting Events.onClick and removing address argument like this:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ button
    [ <span class="kw">class</span> (classNames <span class="dt">Name</span>)
    — , Events.onClick address (<span class="dt">ChangeSort</span> <span class="dt">Name</span>) ]
    ]
    [ text “name” ]</code></pre></div>
<p>new version:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ button
    [ <span class="kw">class</span> (classNames <span class="dt">Name</span>)
    , Events.onClick (<span class="dt">ChangeSort</span> <span class="dt">Name</span>) ]
    [ text “name” ]</code></pre></div>
<p><strong>Now sorting buttons and repository description should work.</strong></p>
<p>This is cool but we are still missing user name update and form submitting. In forms I’d like to use submit instead click since this makes Enter and other handy UX tweaks for mobile. Do you remember that two functions we previously commented out? One of the did the trick with Submit, other one hooks input event. Let’s have a look at <strong>Html.Events</strong> <a href="http://package.elm-lang.org/packages/elm-lang/html/1.0.0/Html-Events">documentation</a>.</p>
<p><strong>Looks like new version have these two build in!</strong></p>
<p>This means we can <strong>remove both commented functions</strong> and give the build-in ones a try.</p>
<p>change:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">input
    [ value model<span class="fu">.</span>userName
    — , onInput address <span class="dt">NameChanged</span>
    , <span class="kw">class</span> “search<span class="fu">-</span>field” ] []</code></pre></div>
<p>to:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">input
    [ value model<span class="fu">.</span>userName
    , Events.onInput <span class="dt">NameChanged</span> ] []</code></pre></div>
<p>and:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">Html.form
    — [ onSubmit address model<span class="fu">.</span>userName
    [ <span class="kw">class</span> “search<span class="fu">-</span>form” ]</code></pre></div>
<p>to:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">Html.form
    [ Events.onSubmit (<span class="dt">FetchData</span> model<span class="fu">.</span>userName)
    , <span class="kw">class</span> “search<span class="fu">-</span>form” ]</code></pre></div>
<p><strong>We are (almost) done!</strong></p>
<p><a href="https://gist.github.com/turboMaCk/ab2ef6e7f9ac393645faa0c6754dda29#file-repos-elm">This</a> is final version of our new implementation.</p>
<h1 id="load-app-in-html">Load app in Html</h1>
<p>Last step is to make new version of application work with Html. Just follow upgrading guide. This how mine index.html looks like:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>HTML<span class="dt">&gt;</span>
<span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">”UTF-8</span><span class="er">&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>Github repository browser<span class="kw">&lt;/title&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">’https://fonts.googleapis.com/css?family=Open+Sans</span><span class="er">&#39;</span><span class="ot"> rel=</span><span class="st">’stylesheet’</span><span class="ot"> type=</span><span class="st">’text/css’</span><span class="kw">&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">’https://fonts.googleapis.com/css?family=Lato:100italic</span><span class="er">&#39;</span><span class="ot"> rel=</span><span class="st">’stylesheet’</span><span class="ot"> type=</span><span class="st">’text/css’</span><span class="kw">&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">”stylesheet”</span><span class="ot"> href=</span><span class="st">”dist/styles/main.css”</span><span class="kw">&gt;</span>
        <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">”text/javascript”</span><span class="ot"> src=</span><span class="st">”dist/Repos.js”</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;/head&gt;</span>
    <span class="kw">&lt;body&gt;</span>
        <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">”text/javascript”</span><span class="kw">&gt;</span>
            <span class="kw">var</span> app <span class="op">=</span> <span class="va">Elm</span>.<span class="va">Repos</span>.<span class="at">fullscreen</span>()<span class="op">;</span>
        <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></code></pre></div>
<p>Nothing too fancy. As you can see there is new api for rendering app in fullscreen.</p>
<p>just change:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> app <span class="op">=</span> <span class="va">Elm</span>.<span class="at">fullscreen</span>(<span class="va">Elm</span>.<span class="at">Repos</span>)<span class="op">;</span></code></pre></div>
<p>to new version:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> app <span class="op">=</span> <span class="va">Elm</span>.<span class="va">Repos</span>.<span class="at">fullscreen</span>()<span class="op">;</span></code></pre></div>
<p>That’s it. We are done!</p>
<h1 id="or-not-edited-on-may-28th">Or not? (edited on May 28th)</h1>
<p>As <a href="https://www.reddit.com/user/jediknight">jediknight</a> pointed out in <a href="https://www.reddit.com/r/elm/comments/4jhaxf/elm_017_successful_upgrade_of_real_world_app_and/">discussion on reddit</a> there is actually much nicer way how to create model msg tuple using <code>!</code> infix function! I recommend to use it since it adds some extra abstraction to your actions. This function takes two a arguments — model (whatever) and List of Msg. Let’s see how we can use it.</p>
<p>this is on of our old update branches:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">update msg model <span class="fu">=</span>
    <span class="kw">case</span> msg <span class="kw">of</span>
        <span class="dt">NoOp</span> <span class="ot">-&gt;</span>
            ( model, Cmd.none )</code></pre></div>
<p>and this is how it looks like with use of <code>!</code> function</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">update msg model <span class="fu">=</span>
    <span class="kw">case</span> msg <span class="kw">of</span>
        <span class="dt">NoOp</span> <span class="ot">-&gt;</span>
            model <span class="fu">!</span> []</code></pre></div>
<p>As always <a href="https://gist.github.com/turboMaCk/a77498c85347eda4581b6be08be8c3ef#file-repos-elm">here</a> is shippet of whole application.</p>
<h1 id="conclusion">Conclusion</h1>
<p>I think this demonstrates one possible pattern of how to upgrade your web app written in elm to version 0.17. We started with views. Removing all calls to code we do not need to just get initial render. Then fixing update function and main (StartApp) code. Doing so bring us to state where we were able to get initial render. Then we made Http work so our app was able to fetch data a render them. We made events work so user can interact with app as before. And finally we connected our app to html.</p>
<h1 id="elm-architecture-types">Elm, Architecture, Types…</h1>
<p>Somewhere above I was taking about how hard it is to upgrade your application. I also mentioned few examples where the difference between legacy and new API made it almost impossible to upgrade existing code bases. I think <strong>with elm the situation is different</strong>.</p>
<p>This is on of scenarios where types really cover your back. Thanks to the fact that elm is <a href="https://en.wikipedia.org/wiki/Strong_and_weak_typing">strongly</a> and <a href="http://stackoverflow.com/questions/1517582/what-is-the-difference-between-statically-typed-and-dynamically-typed-languages">statically</a> typed it’s <strong>not such a big deal to introduce huge API changes</strong> as 0.17 did. I’m not a hardcore static type fan boy. I think there are big trade offs while choosing static over dynamic typed languages. Dynamic typing should be pretty powerful in some cases. I’m also pretty big fan of meta programming (think about Lisp(s) or Ruby). Anyway with static typing comes some extra safety. Extra safety in terms that you no need to be afraid start aggressively rewriting parts of your code. I think this is one thing Elm really shines in. My bets on Elm are pretty high thanks to this. I think Elm’s community can really benefits of this nature of safety. I expect there is <strong>bright future for Elm as language and architecture</strong>. The potential of bringing cutting edge concepts and constantly iterating on all its building blocks can really runs over whole <strong>React</strong> and <strong>Clojure Script</strong> word. I strongly believe that neither of these ecosystems will be able to implement experimental primitives rethink its design and more importantly bring all of this easily to large scale production applications as Elm can.</p>
<p>Thanks to everyone in this community for making all of this happened. I’m super excited about what came next.</p>]]></description>
    <pubDate>Sun, 15 May 2016 00:00:00 UT</pubDate>
    <guid>http://turbomack.github.iuo/posts/2016-05-15-eml-0.17-upgrade.html</guid>
    <dc:creator>Marek Fajkus</dc:creator>
</item>

    </channel>
</rss>
